<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Village Configuration</title>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary: #00d4ff; --save: #2ecc71; --bg: #0f172a; --card: rgba(30, 41, 59, 0.9); }
        body { font-family: 'Prompt', sans-serif; background: #1e293b; color: #f8fafc; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .section-card { background: var(--card); border-radius: 15px; padding: 20px; margin-bottom: 20px; border-left: 5px solid transparent; }
        .section-card.changed { border-left-color: #f1c40f; }
        input { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #334155; background: #0f172a; color: white; box-sizing: border-box; }
        .btn-save { background: var(--save); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; float: right; font-weight: 600; margin-top: 10px; }
        .name-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .warning-text { color: #f1c40f; font-size: 0.8rem; display: none; }
        .changed .warning-text { display: block; }
        .clear { clear: both; }
        h1 { border-bottom: 1px solid #334155; padding-bottom: 15px; margin-bottom: 25px; }
    </style>
</head>
<body>
<div class="container">
    <h1><i class="fas fa-user-shield"></i> ระบบหลังบ้าน (Settings)</h1>

    <div class="section-card" id="card-total">
        <div style="font-weight:600; margin-bottom:10px;"><i class="fas fa-home"></i> จำนวนบ้านทั้งหมด</div>
        <input type="number" id="totalHouses" oninput="markChanged('card-total')">
        <p class="warning-text">⚠️ ข้อมูลเปลี่ยนไป กรุณากดบันทึก</p>
        <button class="btn-save" onclick="saveTotalHouses()">บันทึกจำนวนบ้าน</button>
        <div class="clear"></div>
    </div>

    <div class="section-card" id="card-snooze">
        <div style="font-weight:600; margin-bottom:10px;"><i class="fas fa-clock"></i> ตั้งค่าเวลา Snooze (นาที)</div>
        <div class="name-grid">
            <div><small>ปุ่มที่ 1</small><input type="number" id="snz1" oninput="markChanged('card-snooze')"></div>
            <div><small>ปุ่มที่ 2</small><input type="number" id="snz2" oninput="markChanged('card-snooze')"></div>
            <div><small>ปุ่มที่ 3</small><input type="number" id="snz3" oninput="markChanged('card-snooze')"></div>
            <div><small>ปุ่มที่ 4</small><input type="number" id="snz4" oninput="markChanged('card-snooze')"></div>
        </div>
        <p class="warning-text">⚠️ ข้อมูลเปลี่ยนไป กรุณากดบันทึก</p>
        <button class="btn-save" onclick="saveSnooze()">บันทึกเวลา Snooze</button>
        <div class="clear"></div>
    </div>

    <div class="section-card" id="card-names">
        <div style="font-weight:600; margin-bottom:10px;"><i class="fas fa-tags"></i> ตั้งชื่อเรียกบ้านแต่ละหลัง</div>
        <div id="namesContainer" class="name-grid"></div>
        <p class="warning-text">⚠️ ข้อมูลเปลี่ยนไป กรุณากดบันทึก</p>
        <button class="btn-save" onclick="saveHouseNames()">บันทึกชื่อบ้านทั้งหมด</button>
        <div class="clear"></div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBGVarHKqwjhNR_BGANj8CnSWahIHtJNiM",
        authDomain: "village-security-adf63.firebaseapp.com",
        databaseURL: "https://village-security-adf63-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "village-security-adf63",
        storageBucket: "village-security-adf63.firebasestorage.app",
        appId: "1:943368318320:web:7bfb07a8c1db15952233b5"
    };

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);

    window.markChanged = (id) => { 
        document.getElementById(id).classList.add('changed'); 
        window.unsaved = true; 
    };
    
    window.onbeforeunload = () => window.unsaved ? "คุณยังไม่ได้บันทึกข้อมูล ต้องการออกใช่หรือไม่?" : null;

    window.saveTotalHouses = () => {
        const val = parseInt(document.getElementById('totalHouses').value);
        set(ref(database, 'Settings/TotalHouses'), val).then(() => {
            alert('บันทึกจำนวนบ้านแล้ว'); 
            document.getElementById('card-total').classList.remove('changed');
            checkRemaining();
        });
    };

    window.saveHouseNames = () => {
        const names = {};
        const inputs = document.querySelectorAll('.house-name-input');
        inputs.forEach(inp => { names[inp.dataset.id] = inp.value; });
        set(ref(database, 'Settings/HouseNames'), names).then(() => {
            alert('บันทึกชื่อบ้านแล้ว'); 
            document.getElementById('card-names').classList.remove('changed');
            checkRemaining();
        });
    };

    window.saveSnooze = () => {
        const t = [
            parseInt(document.getElementById('snz1').value), 
            parseInt(document.getElementById('snz2').value), 
            parseInt(document.getElementById('snz3').value), 
            parseInt(document.getElementById('snz4').value)
        ];
        set(ref(database, 'Settings/SnoozeTimes'), t).then(() => {
            alert('บันทึกเวลา Snooze แล้ว'); 
            document.getElementById('card-snooze').classList.remove('changed');
            checkRemaining();
        });
    };

    function checkRemaining() {
        if (document.querySelectorAll('.changed').length === 0) window.unsaved = false;
    }

    onValue(ref(database, 'Settings'), (snap) => {
        const d = snap.val();
        if(!d) return;
        document.getElementById('totalHouses').value = d.TotalHouses || 8;
        
        // วาดชื่อบ้าน
        const container = document.getElementById('namesContainer');
        container.innerHTML = "";
        for(let i=1; i<=d.TotalHouses; i++){
            const currentName = (d.HouseNames && d.HouseNames['House'+i]) || 'บ้านหลังที่ '+i;
            container.innerHTML += `<div><small>หลังที่ ${i}</small><input type="text" class="house-name-input" data-id="House${i}" value="${currentName}" oninput="markChanged('card-names')"></div>`;
        }

        if(d.SnoozeTimes) {
            document.getElementById('snz1').value = d.SnoozeTimes[0];
            document.getElementById('snz2').value = d.SnoozeTimes[1];
            document.getElementById('snz3').value = d.SnoozeTimes[2];
            document.getElementById('snz4').value = d.SnoozeTimes[3];
        }
    });
</script>
</body>
</html>
