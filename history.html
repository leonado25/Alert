<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>ประวัติเหตุการณ์ - Village Security</title>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --accent: #00d4ff; --danger: #e74c3c; --text: #f8fafc; }
        body { font-family: 'Prompt', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; }
        
        .back-link { display: inline-block; color: #94a3b8; text-decoration: none; margin-bottom: 20px; transition: 0.3s; }
        .back-link:hover { color: var(--accent); }

        /* Calendar Styling */
        .calendar-wrapper { background: var(--card); border-radius: 20px; padding: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); margin-bottom: 30px; }
        .cal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px; }
        .day-name { font-weight: 600; color: #64748b; padding-bottom: 10px; text-align: center; }
        .day { background: #334155; aspect-ratio: 1/1; border-radius: 12px; display: flex; align-items: center; justify-content: center; position: relative; cursor: pointer; transition: 0.2s; font-size: 1.1rem; }
        .day:hover { background: #475569; transform: translateY(-2px); }
        .day.today { outline: 2px solid var(--accent); }
        .day.has-event::after { content: ''; width: 8px; height: 8px; background: var(--danger); border-radius: 50%; position: absolute; bottom: 8px; right: 8px; box-shadow: 0 0 5px var(--danger); }
        .day.selected { background: var(--accent); color: #0f172a; font-weight: 600; }

        /* Table Styling */
        .details-wrapper { background: var(--card); border-radius: 20px; padding: 25px; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th { text-align: left; padding: 15px; border-bottom: 2px solid #334155; color: var(--accent); }
        td { padding: 15px; border-bottom: 1px solid #334155; font-size: 0.95rem; }
        .no-data { text-align: center; padding: 40px; color: #64748b; }
        .badge { padding: 4px 10px; border-radius: 6px; font-size: 0.75rem; font-weight: 600; }
        .badge-panic { background: rgba(231, 76, 60, 0.2); color: var(--danger); }
        .badge-alert { background: rgba(241, 196, 15, 0.2); color: #f1c40f; }
    </style>
</head>
<body>

<div class="container">
    <a href="index.html" class="back-link">← กลับไปที่ Dashboard</a>
    
    <div class="calendar-wrapper">
        <div class="cal-header">
            <h2 id="currentMonthYear" style="margin:0;">กำลังโหลด...</h2>
        </div>
        <div id="calendarGrid" class="calendar-grid">
            <div class="day-name">อา.</div><div class="day-name">จ.</div><div class="day-name">อ.</div>
            <div class="day-name">พ.</div><div class="day-name">พฤ.</div><div class="day-name">ศ.</div>
            <div class="day-name">ส.</div>
        </div>
    </div>

    <div class="details-wrapper">
        <h3>ประวัติวันที่ <span id="selectedDateText" style="color:var(--accent);">-</span></h3>
        <div id="logContent">
            <p class="no-data">กรุณาเลือกวันที่ที่มีจุดสีแดงเพื่อดูรายละเอียด</p>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBGVarHKqwjhNR_BGANj8CnSWahIHtJNiM",
        authDomain: "village-security-adf63.firebaseapp.com",
        databaseURL: "https://village-security-adf63-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "village-security-adf63",
        appId: "1:943368318320:web:7bfb07a8c1db15952233b5"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    let auditLogs = {};
    const now = new Date();
    let selectedDay = null;

    onValue(ref(db, 'AuditLogs'), (snapshot) => {
        auditLogs = snapshot.val() || {};
        renderCalendar();
    });

    function renderCalendar() {
        const grid = document.getElementById('calendarGrid');
        const monthLabel = document.getElementById('currentMonthYear');
        
        // ล้างวันที่เดิม (ยกเว้นชื่อวัน)
        const dayNames = grid.querySelectorAll('.day-name');
        grid.innerHTML = '';
        dayNames.forEach(dn => grid.appendChild(dn));

        const firstDay = new Date(now.getFullYear(), now.getMonth(), 1).getDay();
        const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
        
        monthLabel.innerText = now.toLocaleDateString('th-TH', { month: 'long', year: 'numeric' });

        // ช่องว่างก่อนเริ่มวันที่ 1
        for (let i = 0; i < firstDay; i++) {
            grid.appendChild(document.createElement('div'));
        }

        // สร้างวันที่
        for (let day = 1; day <= daysInMonth; day++) {
            const dayDiv = document.createElement('div');
            dayDiv.className = 'day';
            dayDiv.innerText = day;
            
            if(day === now.getDate()) dayDiv.classList.add('today');

            // ตรวจสอบว่าวันนื้มีเหตุการณ์ไหม
            const hasEvent = Object.values(auditLogs).some(log => {
                const logDate = new Date(log.endTime);
                return logDate.getDate() === day && logDate.getMonth() === now.getMonth() && logDate.getFullYear() === now.getFullYear();
            });

            if(hasEvent) dayDiv.classList.add('has-event');

            dayDiv.onclick = () => selectDay(day, dayDiv);
            grid.appendChild(dayDiv);
        }
    }

    function selectDay(day, element) {
        document.querySelectorAll('.day').forEach(d => d.classList.remove('selected'));
        element.classList.add('selected');
        
        const dateStr = `${day} ${now.toLocaleDateString('th-TH', { month: 'long', year: 'numeric' })}`;
        document.getElementById('selectedDateText').innerText = dateStr;

        const filteredLogs = Object.values(auditLogs).filter(log => {
            const logDate = new Date(log.endTime);
            return logDate.getDate() === day && logDate.getMonth() === now.getMonth() && logDate.getFullYear() === now.getFullYear();
        }).sort((a, b) => b.endTime - a.endTime);

        displayLogs(filteredLogs);
    }

    function displayLogs(logs) {
        const container = document.getElementById('logContent');
        if (logs.length === 0) {
            container.innerHTML = '<p class="no-data">ไม่พบข้อมูลเหตุการณ์ในวันนี้</p>';
            return;
        }

        let html = `<table>
            <thead>
                <tr>
                    <th>เริ่มเหตุ</th>
                    <th>บ้าน</th>
                    <th>ประเภท</th>
                    <th>สาเหตุ/สิ่งที่พบ</th>
                    <th>ผู้ตรวจ</th>
                </tr>
            </thead>
            <tbody>`;

        logs.forEach(log => {
            const time = new Date(log.startTime).toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });
            const badgeClass = log.eventType === 'Panic' ? 'badge-panic' : 'badge-alert';
            html += `
                <tr>
                    <td>${time} น.</td>
                    <td><b>${log.houseId}</b></td>
                    <td><span class="badge ${badgeClass}">${log.eventType}</span></td>
                    <td>${log.detail}</td>
                    <td>${log.inspector}</td>
                </tr>`;
        });

        html += '</tbody></table>';
        container.innerHTML = html;
    }
</script>
</body>
</html>
