<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ประวัติเหตุการณ์ - Security History</title>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@200;400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Night Theme */
            --bg: #0b0f19;
            --card: rgba(255, 255, 255, 0.03);
            --text: #e2e8f0;
            --sub: #64748b;
            --accent: #00d4ff;
            --danger: #ff4d4d;
            --table-head: rgba(255, 255, 255, 0.05);
        }

        [data-theme="day"] {
            /* Day Theme */
            --bg: #f1f5f9;
            --card: #ffffff;
            --text: #1e293b;
            --sub: #94a3b8;
            --accent: #0ea5e9;
            --danger: #ef4444;
            --table-head: #f8fafc;
        }

        * { box-sizing: border-box; transition: background 0.4s, color 0.4s; }
        body { font-family: 'Prompt', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; font-weight: 300; }
        .container { max-width: 1000px; margin: 0 auto; }

        /* Header & Nav */
        .nav-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; border-bottom: 1px solid rgba(128,128,128,0.1); padding-bottom: 15px; }
        .back-link { text-decoration: none; color: var(--accent); font-weight: 600; font-size: 0.9rem; }

        /* Calendar Styling */
        .calendar-card { background: var(--card); border-radius: 20px; padding: 25px; border: 1px solid rgba(128,128,128,0.1); margin-bottom: 30px; box-shadow: 0 4px 6px rgba(0,0,0,0.02); }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px; }
        .cal-day-label { font-size: 0.7rem; color: var(--sub); text-transform: uppercase; padding: 10px 0; font-weight: 600; }
        .day { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; background: rgba(128,128,128,0.05); border-radius: 12px; cursor: pointer; position: relative; font-size: 1.1rem; }
        .day:hover { background: var(--accent); color: #000; }
        .day.has-event::after { content: ''; position: absolute; bottom: 8px; width: 6px; height: 6px; background: var(--danger); border-radius: 50%; box-shadow: 0 0 5px var(--danger); }
        .day.selected { outline: 2px solid var(--accent); background: rgba(0, 212, 255, 0.1); }

        /* Table Styling */
        .log-section { background: var(--card); border-radius: 20px; padding: 25px; border: 1px solid rgba(128,128,128,0.1); }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.9rem; }
        th { background: var(--table-head); color: var(--accent); text-align: left; padding: 15px; font-weight: 400; border-bottom: 1px solid rgba(128,128,128,0.1); }
        td { padding: 15px; border-bottom: 1px solid rgba(128,128,128,0.05); color: var(--text); }

        @media (max-width: 600px) {
            .day { font-size: 0.9rem; }
            th, td { padding: 10px; font-size: 0.8rem; }
            .nav-header { flex-direction: column; gap: 10px; text-align: center; }
        }
    </style>
</head>
<body data-theme="night">

<div class="container">
    <div class="nav-header">
        <a href="index.html" class="back-link">← DASHBOARD</a>
        <h2 style="margin:0; font-weight:400; letter-spacing:1px;">EVENT HISTORY</h2>
        <div style="width: 80px;"></div> </div>

    <div class="calendar-card">
        <h3 id="monthYear" style="margin-top:0; font-weight:400; color:var(--accent);">Month Year</h3>
        <div class="calendar-grid" id="calendar">
            <div class="cal-day-label">Sun</div><div class="cal-day-label">Mon</div>
            <div class="cal-day-label">Tue</div><div class="cal-day-label">Wed</div>
            <div class="cal-day-label">Thu</div><div class="cal-day-label">Fri</div>
            <div class="cal-day-label">Sat</div>
            </div>
    </div>

    <div class="log-section">
        <h3 style="margin-top:0; font-weight:400;">รายละเอียดวันที่ <span id="targetDate" style="color:var(--accent);">-</span></h3>
        <div style="overflow-x: auto;">
            <table>
                <thead>
                    <tr><th>เวลา</th><th>บ้าน</th><th>สาเหตุ/เหตุการณ์</th><th>ผู้ตรวจสอบ</th></tr>
                </thead>
                <tbody id="logBody">
                    <tr><td colspan="4" style="text-align:center; color:var(--sub); padding:40px;">กรุณาเลือกวันที่ที่มีจุดสีแดงเพื่อดูรายละเอียด</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const config = {
        apiKey: "AIzaSyBGVarHKqwjhNR_BGANj8CnSWahIHtJNiM",
        authDomain: "village-security-adf63.firebaseapp.com",
        databaseURL: "https://village-security-adf63-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "village-security-adf63",
        appId: "1:943368318320:web:7bfb07a8c1db15952233b5"
    };

    const app = initializeApp(config);
    const db = getDatabase(app);
    let allLogs = {}, themeMode = "night";

    // 1. Sync Theme from Settings
    onValue(ref(db, 'Settings'), (snap) => {
        const s = snap.val() || {};
        themeMode = s.ThemeMode || "night";
        applyTheme(themeMode);
    });

    function applyTheme(m) {
        const h = new Date().getHours();
        let t = "night";
        if (m === "day") t = "day";
        else if (m === "auto") t = (h >= 6 && h < 18) ? "day" : "night";
        document.body.setAttribute('data-theme', t);
    }

    // 2. Load Audit Logs & Render Calendar
    onValue(ref(db, 'AuditLogs'), (snap) => {
        allLogs = snap.val() || {};
        renderCalendar();
    });

    function renderCalendar() {
        const now = new Date();
        const cal = document.getElementById('calendar');
        // Clear old days (keep labels)
        const labels = cal.querySelectorAll('.cal-day-label');
        cal.innerHTML = '';
        labels.forEach(l => cal.appendChild(l));

        document.getElementById('monthYear').innerText = now.toLocaleDateString('th-TH', {month:'long', year:'numeric'});

        const firstDay = new Date(now.getFullYear(), now.getMonth(), 1).getDay();
        const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();

        // Empty spaces for first week
        for (let i = 0; i < firstDay; i++) {
            cal.appendChild(document.createElement('div'));
        }

        for (let i = 1; i <= daysInMonth; i++) {
            const hasEvent = Object.values(allLogs).some(log => {
                const d = new Date(log.timestamp);
                return d.getDate() === i && d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
            });

            const dayEl = document.createElement('div');
            dayEl.className = `day ${hasEvent ? 'has-event' : ''}`;
            dayEl.innerText = i;
            dayEl.onclick = () => showDailyLogs(i, dayEl);
            cal.appendChild(dayEl);
        }
    }

    function showDailyLogs(day, el) {
        // Highlight selection
        document.querySelectorAll('.day').forEach(d => d.classList.remove('selected'));
        el.classList.add('selected');

        const now = new Date();
        const dateStr = `${day} ${now.toLocaleDateString('th-TH', {month:'long', year:'numeric'})}`;
        document.getElementById('targetDate').innerText = dateStr;

        const body = document.getElementById('logBody');
        body.innerHTML = '';

        const logs = Object.values(allLogs).filter(log => {
            const d = new Date(log.timestamp);
            return d.getDate() === day && d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
        }).sort((a, b) => b.timestamp - a.
