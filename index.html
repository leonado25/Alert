<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏†‡∏±‡∏¢ - Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root { --safe: #2ecc71; --danger: #e74c3c; --bg: #0f172a; --card: #1e293b; --text: #f8fafc; }
        body { font-family: 'Prompt', sans-serif; background: var(--bg); color: var(--text); margin: 0; }
        .header { background: var(--card); padding: 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #334155; }
        .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 20px; padding: 20px; }
        .house-card { background: var(--card); border-radius: 15px; padding: 25px; text-align: center; border-bottom: 6px solid var(--safe); transition: 0.3s; }
        .house-card.alert-active { border-bottom-color: var(--danger); animation: blink-bg 0.8s infinite; }
        @keyframes blink-bg { 0%, 100% { background: var(--card); } 50% { background: #450a0a; } }
        .btn { border: none; padding: 10px; border-radius: 8px; cursor: pointer; font-weight: 600; width: 100%; margin-top: 10px; font-family: 'Prompt'; }
        .btn-snooze { background: #64748b; color: white; }
        .btn-close { background: var(--safe); color: white; }
        #clock { font-size: 1.5rem; font-weight: 600; color: #00d4ff; }
        .alert-msg { color: #ff4d4d; font-weight: bold; display: block; margin: 10px 0; }
    </style>
</head>
<body>

<div class="header">
    <h1 id="villageTitle" style="margin:0; font-size: 1.5rem;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</h1>
    <div id="clock">00:00:00</div>
</div>

<div id="dashboard" class="grid-container"></div>

<audio id="sirenSound" loop><source src="https://www.soundjay.com/buttons/beep-01a.mp3" type="audio/mpeg"></audio>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, onValue, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBGVarHKqwjhNR_BGANj8CnSWahIHtJNiM",
        authDomain: "village-security-adf63.firebaseapp.com",
        databaseURL: "https://village-security-adf63-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "village-security-adf63",
        storageBucket: "village-security-adf63.firebasestorage.app",
        appId: "1:943368318320:web:7bfb07a8c1db15952233b5"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let settings = {};
    let isSnoozed = false;
    let snoozeTimer = null;

    // ‡πÇ‡∏´‡∏•‡∏î Settings
    onValue(ref(db, 'Settings'), (snap) => {
        settings = snap.val() || {};
        document.getElementById('villageTitle').innerText = settings.VillageName || "Village Security";
        renderDashboard();
    });

    function renderDashboard() {
        onValue(ref(db, 'Status'), (snapshot) => {
            const statuses = snapshot.val() || {};
            const container = document.getElementById('dashboard');
            container.innerHTML = '';
            let hasAlert = false;

            for (let i = 1; i <= (settings.TotalHouses || 0); i++) {
                // ‡∏î‡∏∂‡∏á ID ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö Arduino (House_001, House_002...)
                const houseId = "House_" + String(i).padStart(3, '0');
                const houseName = (settings.HouseNames && settings.HouseNames[houseId]) || "‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà " + houseId;
                const state = statuses[houseId] || {};

                const isAlerting = state.panic === true || state.check === true;
                if (isAlerting) hasAlert = true;

                const card = document.createElement('div');
                card.className = `house-card ${isAlerting ? 'alert-active' : ''}`;
                card.innerHTML = `
                    <h3 style="margin:5px 0;">${houseName}</h3>
                    ${isAlerting ? `
                        <span class="alert-msg">üö® ${state.message || '‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö‡πÄ‡∏´‡∏ï‡∏∏'}</span>
                        <button class="btn btn-snooze" onclick="window.triggerSnooze()">‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß</button>
                        <button class="btn btn-close" onclick="window.confirmClear('${houseId}')">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</button>
                    ` : '<span style="color:#2ecc71;">‚úÖ ‡∏õ‡∏Å‡∏ï‡∏¥</span>'}
                `;
                container.appendChild(card);
            }
            manageSiren(hasAlert);
        });
    }

    function manageSiren(active) {
        const siren = document.getElementById('sirenSound');
        if (active && !isSnoozed) siren.play().catch(() => {});
        else siren.pause();
    }

    window.triggerSnooze = () => {
        isSnoozed = true; manageSiren(true);
        const sec = settings.SnoozeTime || 30;
        clearTimeout(snoozeTimer);
        snoozeTimer = setTimeout(() => { isSnoozed = false; }, sec * 1000);
        alert(`‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß ${sec} ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ`);
    };

    window.confirmClear = (id) => {
        const updates = {};
        updates[`Status/${id}/panic`] = false;
        updates[`Status/${id}/check`] = false;
        updates[`Status/${id}/message`] = "‡∏õ‡∏Å‡∏ï‡∏¥";
        update(ref(db), updates).then(() => { alert('‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢'); });
    };

    setInterval(() => { document.getElementById('clock').innerText = new Date().toLocaleTimeString('th-TH'); }, 1000);
</script>
</body>
</html>
