<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>ระบบเฝ้าระวังภัย - Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root { --safe: #2ecc71; --danger: #e74c3c; --bg: #0f172a; --card: #1e293b; --text: #f8fafc; }
        body { font-family: 'Prompt', sans-serif; background: var(--bg); color: var(--text); margin: 0; transition: 0.3s; }
        
        .header { background: var(--card); padding: 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #334155; }
        .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 20px; padding: 20px; }
        
        .house-card { background: var(--card); border-radius: 15px; padding: 25px; text-align: center; border-bottom: 6px solid var(--safe); transition: 0.3s; position: relative; }
        
        /* สถานะแจ้งเตือนสีแดงกะพริบตามเงื่อนไขคุณลี */
        .house-card.alert-active { border-bottom-color: var(--danger); animation: blink-bg 1s infinite; }
        
        @keyframes blink-bg { 
            0%, 100% { background: var(--card); } 
            50% { background: #450a0a; } 
        }

        .btn { border: none; padding: 10px; border-radius: 8px; cursor: pointer; font-weight: 600; width: 100%; margin-top: 10px; font-family: 'Prompt'; }
        .btn-snooze { background: #64748b; color: white; margin-bottom: 5px; }
        .btn-close { background: var(--safe); color: white; }
        
        #clock { font-size: 1.5rem; font-weight: 600; color: #00d4ff; }
        .status-tag { font-size: 0.8rem; padding: 4px 8px; border-radius: 4px; background: #334155; margin-bottom: 10px; display: inline-block; }
    </style>
</head>
<body>

<div class="header">
    <div>
        <h1 id="villageTitle" style="margin:0; font-size: 1.5rem;">ระบบรักษาความปลอดภัย</h1>
    </div>
    <div id="clock">00:00:00</div>
</div>

<div id="dashboard" class="grid-container">
    </div>

<audio id="sirenSound" loop>
    <source src="https://www.soundjay.com/buttons/beep-01a.mp3" type="audio/mpeg">
</audio>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, onValue, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    // ใช้ Config เดียวกับหน้า Setting ของคุณลี
    const firebaseConfig = {
        apiKey: "AIzaSyBGVarHKqwjhNR_BGANj8CnSWahIHtJNiM",
        authDomain: "village-security-adf63.firebaseapp.com",
        databaseURL: "https://village-security-adf63-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "village-security-adf63",
        storageBucket: "village-security-adf63.firebasestorage.app",
        appId: "1:943368318320:web:7bfb07a8c1db15952233b5"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let appSettings = {};
    let isSnoozed = false;
    let snoozeTimer = null;

    // 1. ดึงค่า Config (ดึงตามกิ่งที่ไฟล์ Setting คุณลีบันทึกไว้)
    onValue(ref(db, 'Settings'), (snapshot) => {
        appSettings = snapshot.val() || {};
        document.getElementById('villageTitle').innerText = appSettings.VillageName || "หมู่บ้านรักษาความปลอดภัย";
        // ปรับธีมเบื้องต้น
        if(appSettings.Theme === 'light') document.body.style.background = "#f8fafc";
    });

    // 2. ดึงสถานะการแจ้งเตือนจาก Status
    onValue(ref(db, 'Status'), (snapshot) => {
        const statuses = snapshot.val() || {};
        const container = document.getElementById('dashboard');
        container.innerHTML = '';
        
        let shouldPlaySiren = false;
        const total = appSettings.TotalHouses || 0;

        for (let i = 1; i <= total; i++) {
            const houseId = "House" + i; // ตรงกับ data-id="House"+i ในหน้า Setting
            const houseName = (appSettings.HouseNames && appSettings.HouseNames[houseId]) || "บ้านหลังที่ " + i;
            const state = statuses[houseId] || {};

            // ตรวจสอบว่ามีการแจ้งเตือนค้างอยู่หรือไม่ (IO4 หรือ IO5)
            const isAlerting = state.panic === true || state.check === true;
            if (isAlerting) shouldPlaySiren = true;

            const card = document.createElement('div');
            card.className = `house-card ${isAlerting ? 'alert-active' : ''}`;
            
            card.innerHTML = `
                <div class="status-tag">${isAlerting ? '⚠️ ตรวจพบเหตุ' : '✅ ปกติ'}</div>
                <h3 style="margin:10px 0;">${houseName}</h3>
                <p style="font-size:0.9rem; color:#94a3b8;">${state.message || 'รอกดปุ่มจาก Arduino'}</p>
                
                ${isAlerting ? `
                    <button class="btn btn-snooze" onclick="window.runSnooze()">ปิดเสียงชั่วคราว</button>
                    <button class="btn btn-close" onclick="window.closeJob('${houseId}')">บันทึกการตรวจสอบ</button>
                ` : ''}
            `;
            container.appendChild(card);
        }

        controlSiren(shouldPlaySiren);
    });

    // --- ระบบควบคุมเสียงและ Snooze ---
    function controlSiren(hasAlert) {
        const siren = document.getElementById('sirenSound');
        if (hasAlert && !isSnoozed) {
            siren.play().catch(() => {});
        } else {
            siren.pause();
        }
    }

    window.runSnooze = () => {
        isSnoozed = true;
        controlSiren(true); // จะหยุดเพราะ isSnoozed เป็น true
        
        // ดึงเวลา Snooze จากอาเรย์ (ตัวอย่างดึงค่าแรก หรือคำนวณตามต้องการ)
        const timeInSeconds = (appSettings.SnoozeTimes ? appSettings.SnoozeTimes[0] : 30);
        
        clearTimeout(snoozeTimer);
        snoozeTimer = setTimeout(() => {
            isSnoozed = false;
            // เมื่อหมดเวลา ระบบจะกลับมาดังใหม่เองเพราะ onValue จะทำงานอีกรอบ
        }, timeInSeconds * 1000);
        
        alert(`ปิดเสียงชั่วคราวเป็นเวลา ${timeInSeconds} วินาที`);
    };

    window.closeJob = (id) => {
        // อัปเดต Firebase ให้กลับเป็นปกติ (Latch Alarm จะหายเมื่อกดปุ่มนี้)
        const updates = {};
        updates[`Status/${id}/panic`] = false;
        updates[`Status/${id}/check`] = false;
        updates[`Status/${id}/message`] = "ตรวจสอบเรียบร้อย";

        update(ref(db), updates).then(() => {
            alert("บันทึกผลการตรวจสอบบ้าน " + id + " สำเร็จ");
        });
    };

    // นาฬิกา
    setInterval(() => {
        document.getElementById('clock').innerText = new Date().toLocaleTimeString('th-TH');
    }, 1000);
</script>
</body>
</html>
