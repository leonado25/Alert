<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>ระบบเฝ้าระวังภัย - Real-time Dashboard</title>
    <style>
        :root { --bg: #f0f2f5; --text: #1c1e21; --card: #ffffff; --safe: #28a745; --danger: #dc3545; }
        [data-theme="dark"] { --bg: #18191a; --text: #e4e6eb; --card: #242526; }
        body { background: var(--bg); color: var(--text); font-family: sans-serif; margin: 0; transition: 0.3s; }
        .header { background: var(--card); padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; padding: 20px; }
        .house-card { background: var(--card); border-radius: 12px; padding: 20px; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.1); border-bottom: 5px solid var(--safe); transition: 0.3s; }
        .house-card.alert-panic { border-bottom-color: var(--danger); animation: blink-red 1s infinite; }
        .house-card.alert-check { border-bottom-color: #ffc107; animation: blink-orange 1s infinite; }
        @keyframes blink-red { 0%, 100% { background: var(--card); } 50% { background: #ffcccc; } }
        @keyframes blink-orange { 0%, 100% { background: var(--card); } 50% { background: #fff3cd; } }
        .btn { cursor: pointer; border: none; padding: 8px 15px; border-radius: 5px; margin: 5px; font-weight: bold; }
        .btn-snooze { background: #6c757d; color: white; }
        .btn-close { background: var(--safe); color: white; }
        .btn-close:disabled { background: #ccc; cursor: not-allowed; }
        #siren-player { display: none; }
    </style>
</head>
<body>

<div class="header">
    <h1 id="villageTitle">กำลังโหลดชื่อโครงการ...</h1>
    <div id="clock" style="font-size: 1.5rem; font-weight: bold;">00:00:00</div>
</div>

<div id="dashboard" class="grid-container">
    </div>

<audio id="sirenSound" loop>
    <source src="https://www.soundjay.com/buttons/beep-01a.mp3" type="audio/mpeg">
</audio>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, onValue, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = { databaseURL: "https://village-security-adf63-default-rtdb.asia-southeast1.firebasedatabase.app" };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let settings = {};
    let snoozeTimer = null;
    let isSnoozed = false;

    // 1. โหลดการตั้งค่าโครงการ
    onValue(ref(db, 'Settings'), (snapshot) => {
        settings = snapshot.val() || {};
        document.getElementById('villageTitle').innerText = settings.village_name || "ระบบรักษาความปลอดภัย";
        if(settings.theme) applyTheme(settings.theme);
        initDashboard();
    });

    // 2. โหลดสถานะบ้านและเฝ้าดูการเปลี่ยนแปลง
    function initDashboard() {
        const statusRef = ref(db, 'Status');
        onValue(statusRef, (snapshot) => {
            const statuses = snapshot.val() || {};
            const container = document.getElementById('dashboard');
            container.innerHTML = '';

            let hasAnyAlert = false;

            for (let i = 1; i <= settings.house_count; i++) {
                const id = "House_" + String(i).padStart(3, '0');
                const name = (settings.houses && settings.houses[id]) ? settings.houses[id] : id;
                const state = statuses[id] || {};

                const card = document.createElement('div');
                card.className = `house-card ${state.panic ? 'alert-panic' : (state.check ? 'alert-check' : '')}`;
                
                let alertMsg = state.panic ? "!!! ขอความช่วยเหลือ (Panic) !!!" : (state.check ? "แจ้งเตือนตรวจสอบ" : "ปกติ");
                if (state.panic || state.check) hasAnyAlert = true;

                card.innerHTML = `
                    <h3>${name}</h3>
                    <p>${alertMsg}</p>
                    ${(state.panic || state.check) ? `
                        <button class="btn btn-snooze" onclick="handleSnooze()">ปิดเสียงชั่วคราว</button>
                        <button class="btn btn-close" onclick="closeJob('${id}')">ปิดงาน/บันทึกผล</button>
                    ` : ''}
                `;
                container.appendChild(card);
            }

            handleAlarmSound(hasAnyAlert);
        });
    }

    // 3. ระบบจัดการเสียง
    function handleAlarmSound(hasAlert) {
        const siren = document.getElementById('sirenSound');
        if (hasAlert && !isSnoozed) {
            siren.play().catch(e => console.log("User must interact first"));
        } else {
            siren.pause();
        }
    }

    window.handleSnooze = function() {
        isSnoozed = true;
        handleAlarmSound(true); // จะหยุดเพราะ isSnoozed เป็น true
        const duration = (settings.snooze_duration || 30) * 1000;
        
        clearTimeout(snoozeTimer);
        snoozeTimer = setTimeout(() => {
            isSnoozed = false;
            // เมื่อหมดเวลา ระบบจะกลับไปตรวจสอบ Alarm อัตโนมัติจาก onValue
        }, duration);
        alert(`ปิดเสียงชั่วคราว ${settings.snooze_duration} วินาที`);
    };

    window.closeJob = function(houseId) {
        // ในที่นี้คือการ Reset ค่ากลับเป็น false ใน Firebase
        const updates = {};
        updates[`Status/${houseId}/panic`] = false;
        updates[`Status/${houseId}/check`] = false;
        updates[`Status/${houseId}/message`] = "ปกติ";

        update(ref(db), updates).then(() => {
            alert("บันทึกการตรวจสอบเรียบร้อย");
        });
    };

    function applyTheme(mode) {
        if(mode === 'dark') document.body.setAttribute('data-theme', 'dark');
        else document.body.removeAttribute('data-theme');
    }

    setInterval(() => {
        document.getElementById('clock').innerText = new Date().toLocaleTimeString('th-TH');
    }, 1000);
</script>
</body>
</html>
