<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Village Security - Stable</title>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary: #00d4ff; --bg: #0f172a; --card: rgba(30, 41, 59, 0.7); --text: #fff; --danger: #ff4d4d; --success: #2ecc71; --warning: #f1c40f; }
        .light-mode { --bg: #f1f5f9; --card: #ffffff; --text: #1e293b; --primary: #0284c7; }
        body { font-family: 'Prompt', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; transition: 0.5s; }
        .stats-bar { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 30px; }
        .stat-card { background: var(--card); padding: 15px; border-radius: 12px; text-align: center; border: 1px solid rgba(255,255,255,0.1); }
        .houses-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        .house-card { background: var(--card); border-radius: 20px; padding: 20px; border: 2px solid transparent; transition: 0.3s; }
        .house-card.alert { border-color: var(--danger); background: rgba(255, 77, 77, 0.1); }
        .house-card.snoozed { border-color: var(--warning); }
        .btn-action { width: 100%; padding: 10px; border: none; border-radius: 8px; font-family: 'Prompt'; font-weight: 600; cursor: pointer; margin-top: 8px; }
        .input-log { width: 100%; padding: 10px; border-radius: 5px; border: 1px solid #ccc; margin-top: 10px; box-sizing: border-box; }
    </style>
</head>
<body onclick="document.getElementById('siren').pause()">

    <h1 style="text-align: center;" id="vName">Smart Village</h1>

    <div class="stats-bar">
        <div class="stat-card"><span>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢</span><div>‚úÖ</div></div>
        <div class="stat-card"><span>‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</span><a href="history.html" style="color:var(--primary); font-size:1.5rem; text-decoration:none;" id="mCount">0</a></div>
        <div class="stat-card"><span>‡∏õ‡∏µ‡∏ô‡∏µ‡πâ</span><a href="history.html" style="color:var(--primary); font-size:1.5rem; text-decoration:none;" id="yCount">0</a></div>
    </div>

    <div class="houses-grid" id="container"></div>
    <audio id="siren" loop><source src="https://www.soundjay.com/buttons/beep-01a.mp3" type="audio/mpeg"></audio>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, onValue, set, push, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBGVarHKqwjhNR_BGANj8CnSWahIHtJNiM",
        authDomain: "village-security-adf63.firebaseapp.com",
        databaseURL: "https://village-security-adf63-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "village-security-adf63",
        storageBucket: "village-security-adf63.firebasestorage.app",
        appId: "1:943368318320:web:7bfb07a8c1db15952233b5"
    };

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);
    const siren = document.getElementById('siren');

    let settings = {};
    let activeAlarms = {}; // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡πâ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤

    // 1. ‡∏î‡∏∂‡∏á Settings
    onValue(ref(database, 'Settings'), (s) => {
        settings = s.val() || {};
        document.getElementById('vName').innerText = settings.VillageName || "Smart Village";
        document.body.className = settings.Theme === 'light' ? 'light-mode' : '';
    });

    // 2. ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å Houses ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏∏‡∏°‡∏•‡∏≠‡∏à‡∏¥‡∏Å Latch/Snooze
    onValue(ref(database, 'Houses'), (snap) => {
        const houses = snap.val() || {};
        const container = document.getElementById('container');
        container.innerHTML = '';
        let playSiren = false;
        const now = Date.now();

        const total = parseInt(settings.TotalHouses) || 10;
        for (let i = 1; i <= total; i++) {
            const id = `House${i}`;
            const sensor = houses[id] || 0; // 0 ‡∏´‡∏£‡∏∑‡∏≠ 1

            // ‡∏ñ‡πâ‡∏≤ Sensor ‡πÄ‡∏õ‡πá‡∏ô 1 ‡πÅ‡∏•‡∏∞‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Alarm ‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ (Latch ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô)
            if (sensor == 1 && !activeAlarms[id]) {
                activeAlarms[id] = { startTime: new Date().toISOString(), snoozed: false, until: 0 };
            }

            const alarm = activeAlarms[id];
            const hasAlarm = !!alarm;

            // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤ Snooze ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
            if (hasAlarm && alarm.snoozed && now > alarm.until) {
                if (sensor == 1) alarm.snoozed = false; // ‡∏ñ‡πâ‡∏≤‡∏™‡∏≤‡∏¢‡∏¢‡∏±‡∏á‡∏ä‡πá‡∏≠‡∏ï ‡πÉ‡∏´‡πâ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏î‡∏±‡∏á
            }

            // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ Alarm ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ Snooze ‡∏≠‡∏¢‡∏π‡πà ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ã‡πÄ‡∏£‡∏ô
            if (hasAlarm && !alarm.snoozed) playSiren = true;

            const name = (settings.HouseNames && settings.HouseNames[id]) || `‡∏ö‡πâ‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏ó‡∏µ‡πà ${i}`;
            const card = document.createElement('div');
            card.className = `house-card ${hasAlarm ? (alarm.snoozed ? 'snoozed' : 'alert') : ''}`;
            card.innerHTML = `
                <h3>${name}</h3>
                <p>${hasAlarm ? (alarm.snoozed ? 'üü° ‡∏û‡∏±‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß' : 'üî¥ ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ö‡∏∏‡∏Å‡∏£‡∏∏‡∏Å!') : 'üü¢ ‡∏õ‡∏Å‡∏ï‡∏¥'}</p>
                ${hasAlarm && !alarm.snoozed ? `<button class="btn-action" style="background:var(--warning)" onclick="window.doSnooze('${id}')">Snooze</button>` : ''}
                ${hasAlarm ? `<input type="text" id="log-${id}" class="input-log" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏..."><button class="btn-action" style="background:var(--success); color:white" onclick="window.doClose('${id}')">‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô</button>` : ''}
            `;
            container.appendChild(card);
        }

        if (playSiren) siren.play().catch(()=>{}); else siren.pause();
    });

    window.doSnooze = (id) => {
        const time = parseInt(settings.SnoozeTime) || 5;
        activeAlarms[id].snoozed = true;
        activeAlarms[id].until = Date.now() + (time * 60 * 1000);
        renderManually();
    };

    window.doClose = (id) => {
        const log = document.getElementById(`log-${id}`).value;
        if(!log) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏Ñ‡πà‡∏∞");
        
        push(ref(database, 'History'), {
            houseName: (settings.HouseNames && settings.HouseNames[id]) || id,
            startTime: activeAlarms[id].startTime,
            endTime: new Date().toISOString(),
            log: log,
            timestamp: serverTimestamp()
        }).then(() => {
            delete activeAlarms[id];
            alert("‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
            renderManually();
        });
    };

    function renderManually() { onValue(ref(database, 'Houses'), ()=>{}, {onlyOnce: true}); }

    onValue(ref(database, 'History'), (snap) => {
        const count = snap.val() ? Object.keys(snap.val()).length : 0;
        document.getElementById('mCount').innerText = count;
        document.getElementById('yCount').innerText = count;
    });
</script>
</body>
</html>
