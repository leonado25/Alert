<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Security Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --danger: #ff4d4d; --primary: #00d4ff; --card: rgba(30, 41, 59, 0.7); }
        body { font-family: 'Prompt', sans-serif; background: #0f172a; color: white; margin: 0; padding: 15px; }
        
        /* ‡πÅ‡∏ñ‡∏ö‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥ */
        .stats-bar { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px; }
        .stat-card { background: var(--card); padding: 15px; border-radius: 15px; text-align: center; cursor: pointer; border: 1px solid rgba(255,255,255,0.1); transition: 0.3s; }
        .stat-card:hover { transform: translateY(-3px); border-color: var(--primary); }
        .stat-val { font-size: 1.5rem; font-weight: 600; color: var(--primary); }
        
        /* ‡πÅ‡∏ñ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏î‡πà‡∏ß‡∏ô */
        #quickAlert { display: none; background: var(--danger); color: white; padding: 10px; border-radius: 10px; margin-bottom: 20px; font-weight: 600; text-align: center; animation: blink 1s infinite; cursor: pointer; }
        
        .village-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; }
        .house-card { background: var(--card); border-radius: 15px; padding: 15px; text-align: center; border: 2px solid transparent; transition: 0.5s; }
        .house-card.alarm { border-color: var(--danger); background: rgba(255, 77, 77, 0.2); }
        .house-icon { font-size: 2rem; color: var(--primary); }
        .alarm .house-icon { color: var(--danger); animation: shake 0.5s infinite; }

        #alertModal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 99; padding: 20px; }
        .modal-content { background: #1e293b; max-width: 400px; margin: 50px auto; padding: 30px; border-radius: 20px; text-align: center; border: 2px solid var(--danger); }
        .btn-snooze { background: #f1c40f; padding: 10px; border: none; border-radius: 5px; margin: 5px; width: 45%; font-family: 'Prompt'; cursor: pointer; }

        @keyframes blink { 50% { opacity: 0.7; } }
        @keyframes shake { 0%, 100% { transform: rotate(0); } 25% { transform: rotate(5deg); } 75% { transform: rotate(-5deg); } }
    </style>
</head>
<body>

    <div class="stats-bar">
        <div class="stat-card">
            <small>‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß</small>
            <div class="stat-val" id="safeDays">0 ‡∏ß‡∏±‡∏ô</div>
        </div>
        <div class="stat-card" onclick="location.href='history.html?view=month'">
            <small>‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡πÄ‡∏´‡∏ï‡∏∏</small>
            <div class="stat-val" id="monthEvents">0 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</div>
        </div>
        <div class="stat-card" onclick="location.href='history.html?view=year'">
            <small>‡∏õ‡∏µ‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡πÄ‡∏´‡∏ï‡∏∏</small>
            <div class="stat-val" id="yearEvents">0 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</div>
        </div>
    </div>

    <div id="quickAlert" onclick="scrollToAlarm()">üö® ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏î‡πà‡∏ß‡∏ô: <span id="alertList"></span></div>

    <div class="village-grid" id="villageGrid"></div>

    <div id="alertModal">
        <div class="modal-content">
            <h2 style="color:var(--danger)">‡∏û‡∏ö‡∏Å‡∏≤‡∏£‡∏ö‡∏∏‡∏Å‡∏£‡∏∏‡∏Å!</h2>
            <h3 id="modalName">‡∏ö‡πâ‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏ó‡∏µ‡πà X</h3>
            <div id="snoozeBtns"></div>
            <button onclick="closeModal()" style="width:100%; padding:10px; margin-top:10px; background:#2ecc71; border:none; color:white; border-radius:5px;">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß</button>
        </div>
    </div>

    <audio id="siren" loop src="https://www.soundjay.com/buttons/beep-01a.mp3"></audio>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBGVarHKqwjhNR_BGANj8CnSWahIHtJNiM",
        authDomain: "village-security-adf63.firebaseapp.com",
        databaseURL: "https://village-security-adf63-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "village-security-adf63",
        storageBucket: "village-security-adf63.firebasestorage.app",
        appId: "1:943368318320:web:7bfb07a8c1db15952233b5"
    };

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);
    let houseNames = {};
    let activeAlarms = [];

    // ‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤
    onValue(ref(database, 'Settings'), (snap) => {
        const d = snap.val();
        if(!d) return;
        houseNames = d.HouseNames || {};
        renderVillage(d.TotalHouses || 8);
        renderSnooze(d.SnoozeTimes || [3,15,30,60]);
    });

    function renderVillage(total) {
        const grid = document.getElementById('villageGrid');
        grid.innerHTML = "";
        for(let i=1; i<=total; i++){
            grid.innerHTML += `<div class="house-card" id="card-House${i}"><i class="fas fa-house-shield house-icon"></i><div>${houseNames['House'+i] || '‡∏´‡∏•‡∏±‡∏á‡∏ó‡∏µ‡πà '+i}</div></div>`;
        }
        listenHouses(total);
    }

    function renderSnooze(times) {
        const cont = document.getElementById('snoozeBtns');
        cont.innerHTML = "";
        times.forEach(t => {
            cont.innerHTML += `<button class="btn-snooze" onclick="alert('‡∏û‡∏±‡∏Å ${t} ‡∏ô‡∏≤‡∏ó‡∏µ')">‡∏û‡∏±‡∏Å ${t} ‡∏°.</button>`;
        });
    }

    function listenHouses(total) {
        onValue(ref(database, 'Houses'), (snap) => {
            const data = snap.val() || {};
            activeAlarms = [];
            for(let i=1; i<=total; i++){
                const id = 'House'+i;
                const card = document.getElementById('card-'+id);
                if(data[id] == 1) {
                    card.classList.add('alarm');
                    activeAlarms.push(houseNames[id] || '‡∏´‡∏•‡∏±‡∏á‡∏ó‡∏µ‡πà '+i);
                } else {
                    card.classList.remove('alarm');
                }
            }
            updateAlertUI();
        });
    }

    function updateAlertUI() {
        const bar = document.getElementById('quickAlert');
        const siren = document.getElementById('siren');
        if(activeAlarms.length > 0) {
            bar.style.display = 'block';
            document.getElementById('alertList').innerText = activeAlarms.join(', ');
            document.getElementById('alertModal').style.display = 'block';
            document.getElementById('modalName').innerText = activeAlarms[0];
            siren.play().catch(() => {});
        } else {
            bar.style.display = 'none';
            document.getElementById('alertModal').style.display = 'none';
            siren.pause();
        }
    }

    window.scrollToAlarm = () => {
        const firstAlarm = document.querySelector('.alarm');
        if(firstAlarm) firstAlarm.scrollIntoView({ behavior: 'smooth', block: 'center' });
    };

    window.closeModal = () => document.getElementById('alertModal').style.display = 'none';
    document.body.onclick = () => {}; // ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÑ‡∏î‡πâ
</script>
</body>
</html>
