<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Village Security Dashboard</title>

<link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
:root {
  --danger:#ff4d4d;
  --primary:#00d4ff;
  --warning:#f1c40f;
  --success:#2ecc71;
  --bg:#0f172a;
  --card:rgba(30,41,59,0.7);
  --text:#fff;
}
body{
  font-family:'Prompt',sans-serif;
  background:var(--bg);
  color:var(--text);
  margin:0;
  padding:15px;
}
.header{text-align:center;margin-bottom:20px}
.village-title{font-size:1.8rem;font-weight:600;color:var(--primary)}
.stats-bar{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin:15px 0}
.stat-card{background:var(--card);padding:10px;border-radius:12px;text-align:center}
.stat-val{font-size:1.2rem;font-weight:600;color:var(--primary)}
#quickAlert{
  display:none;
  background:var(--danger);
  padding:12px;
  border-radius:10px;
  margin-bottom:15px;
  font-weight:600;
  cursor:pointer;
}
.village-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:15px}
.house-card{
  background:var(--card);
  border-radius:15px;
  padding:15px;
  border:2px solid transparent;
  box-shadow:0 4px 15px rgba(0,0,0,.2);
}
.house-card.alarm{border-color:var(--danger);background:rgba(255,77,77,.15)}
.house-card.checking{border-color:var(--warning);background:rgba(241,196,15,.15)}
.house-main{display:flex;align-items:center;gap:15px}
.house-icon{font-size:2.2rem;color:var(--primary)}
.alarm .house-icon{color:var(--danger);animation:shake .5s infinite}
.controls-panel{display:none;margin-top:15px;padding-top:15px;border-top:1px solid rgba(255,255,255,.2)}
.alarm .controls-panel,.checking .controls-panel{display:block}
.snooze-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:5px;margin-bottom:10px}
.btn-snz{padding:8px;border:none;border-radius:5px;background:var(--warning);font-weight:600;cursor:pointer}
.btn-action{width:100%;padding:12px;border:none;border-radius:8px;color:#000;font-weight:600;cursor:pointer}
.btn-solve{background:var(--success)}
.btn-confirm{background:var(--primary)}
.timer-display{background:rgba(0,0,0,.3);padding:6px;border-radius:6px;margin-bottom:10px;text-align:center}
.solve-step-2{display:none}
.input-log{width:100%;padding:10px;border-radius:8px;border:none;margin-bottom:8px}
#startOverlay{
  position:fixed;inset:0;background:#0f172a;z-index:9999;
  display:flex;flex-direction:column;align-items:center;justify-content:center
}
@keyframes shake{
  0%,100%{transform:rotate(0)}
  25%{transform:rotate(5deg)}
  75%{transform:rotate(-5deg)}
}
</style>
</head>

<body>

<div id="startOverlay">
  <i class="fas fa-shield-alt" style="font-size:5rem;color:var(--primary)"></i>
  <h2>‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢</h2>
  <button id="btnStart" class="btn-action">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏ö‡∏ö</button>
</div>

<div class="header">
  <h1 class="village-title" id="villageDisplay">Loading...</h1>
  <div class="stats-bar">
    <div class="stat-card">‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ <span class="stat-val">‚Äì</span></div>
    <div class="stat-card">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ <span class="stat-val">‚Äì</span></div>
    <div class="stat-card">‡∏õ‡∏µ‡∏ô‡∏µ‡πâ <span class="stat-val">‚Äì</span></div>
  </div>
</div>

<div id="quickAlert" onclick="scrollToAlarm()">üö® ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô: <span id="alertList"></span></div>
<div class="village-grid" id="villageGrid"></div>

<audio id="siren" loop>
  <source src="https://www.soundjay.com/buttons/beep-01a.mp3">
</audio>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, onValue, get, push } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBGVarHKqwjhNR_BGANj8CnSWahIHtJNiM",
  databaseURL: "https://village-security-adf63-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "village-security-adf63"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let settings={}, localState={}, timers={}, audioReady=false;
const siren=document.getElementById('siren');

btnStart.onclick=()=>{
  siren.play().then(()=>{
    siren.pause();siren.currentTime=0;
    audioReady=true;
    startOverlay.style.display="none";
  });
};

onValue(ref(db,'Settings'),snap=>{
  settings=snap.val()||{};
  villageDisplay.innerText=settings.VillageName||"Smart Village";
  render();
});

function render(){
  villageGrid.innerHTML="";
  for(let i=1;i<=settings.TotalHouses;i++){
    const id="House"+i;
    villageGrid.innerHTML+=`
    <div class="house-card" id="card-${id}">
      <div class="house-main">
        <i class="fas fa-home house-icon"></i>
        <div>
          <b>${settings.HouseNames?.[id]||"‡∏´‡∏•‡∏±‡∏á‡∏ó‡∏µ‡πà "+i}</b>
          <div id="txt-${id}">‡∏õ‡∏Å‡∏ï‡∏¥</div>
        </div>
      </div>
      <div class="controls-panel">
        <span id="timer-${id}" class="timer-display" style="display:none"></span>
        <div class="snooze-grid">
          ${(settings.SnoozeTimes||[5,15,30,60]).map(t=>`<button class="btn-snz" onclick="snooze('${id}',${t})">${t}‡∏°.</button>`).join("")}
        </div>
        <button class="btn-action btn-solve" onclick="resolve('${id}')">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß</button>
        <div class="solve-step-2" id="step2-${id}">
          <input class="input-log" id="log-${id}" placeholder="‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏">
          <button class="btn-action btn-confirm" onclick="closeCase('${id}')">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏õ‡∏¥‡∏î‡πÄ‡∏Ñ‡∏™</button>
        </div>
      </div>
    </div>`;
    localState[id]="normal";
  }
  listen();
}

function listen(){
  onValue(ref(db,'Houses'),snap=>{
    const data=snap.val()||{};
    let alerts=[],play=false;

    for(let i=1;i<=settings.TotalHouses;i++){
      const id="House"+i;
      const s=data[id];
      const card=document.getElementById(`card-${id}`);
      const txt=document.getElementById(`txt-${id}`);

      if(s===1){
        if(localState[id]==="normal") localState[id]="alarm";
        if(localState[id]==="ready") localState[id]="alarm";
      }
      if(s===0 && localState[id]==="checking") localState[id]="ready";

      card.className="house-card";
      if(localState[id]==="alarm"){
        card.classList.add("alarm"); txt.innerText="‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô";
        alerts.push(id); play=true;
      }
      if(localState[id]==="checking"){
        card.classList.add("checking"); txt.innerText="‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö";
        alerts.push(id);
      }
      if(localState[id]==="ready"){
        card.classList.add("checking"); txt.innerText="‡πÅ‡∏Å‡πâ‡πÅ‡∏•‡πâ‡∏ß ‡∏£‡∏≠‡∏õ‡∏¥‡∏î‡πÄ‡∏Ñ‡∏™";
        alerts.push(id);
      }
      if(localState[id]==="normal") txt.innerText="‡∏õ‡∏Å‡∏ï‡∏¥";
    }

    quickAlert.style.display=alerts.length?"block":"none";
    alertList.innerText=alerts.join(", ");

    if(play && audioReady) siren.play().catch(()=>{});
    else{ siren.pause(); siren.currentTime=0; }
  });
}

window.snooze=(id,min)=>{
  if(timers[id]) return;
  localState[id]="checking";
  let t=min*60;
  const el=document.getElementById(`timer-${id}`);
  el.style.display="block";
  timers[id]=setInterval(()=>{
    el.innerText=`‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${Math.floor(t/60)}:${(t%60).toString().padStart(2,'0')}`;
    if(t--<=0){
      clearInterval(timers[id]);
      timers[id]=null;
      el.style.display="none";
      get(ref(db,'Houses/'+id)).then(s=>{
        if(s.val()===1) localState[id]="alarm";
      });
    }
  },1000);
};

window.resolve=id=>{
  get(ref(db,'Houses/'+id)).then(s=>{
    if(s.val()===1) alert("‡∏¢‡∏±‡∏á‡∏°‡∏µ‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥");
    else document.getElementById(`step2-${id}`).style.display="block";
  });
};

window.closeCase=id=>{
  const text=document.getElementById(`log-${id}`).value.trim();
  if(!text) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏");
  push(ref(db,'History'),{house:id,reason:text,time:new Date().toISOString()});
  localState[id]="normal";
  document.getElementById(`step2-${id}`).style.display="none";
  document.getElementById(`log-${id}`).value="";
};

window.scrollToAlarm=()=>{
  const el=document.querySelector(".alarm,.checking");
  if(el) el.scrollIntoView({behavior:"smooth"});
};
</script>

</body>
</html>
