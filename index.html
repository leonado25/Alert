<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Village Security - Stable Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --danger: #ff4d4d; --primary: #00d4ff; --warning: #f1c40f; --success: #2ecc71; --bg: #0f172a; --card: rgba(30, 41, 59, 0.7); --text: #fff; }
        .light-mode { --bg: #f1f5f9; --card: #ffffff; --text: #1e293b; --primary: #0284c7; }
        body { font-family: 'Prompt', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 15px; transition: 0.5s; }
        .stat-val { font-size: 1.2rem; font-weight: 600; color: var(--primary); cursor: pointer; }
        .village-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; }
        .house-card { background: var(--card); border-radius: 15px; padding: 15px; border: 2px solid transparent; position: relative; }
        .house-card.alarm { border-color: var(--danger); background: rgba(255, 77, 77, 0.15); }
        .house-card.checking { border-color: var(--warning); background: rgba(241, 196, 15, 0.15); }
        .btn-snz { padding: 8px; border: none; border-radius: 5px; background: var(--warning); color: #000; font-weight: 600; cursor: pointer; }
        .btn-action { width: 100%; padding: 12px; border: none; border-radius: 8px; color: white; font-weight: 600; cursor: pointer; margin-top: 10px; }
        .input-log { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ccc; margin-bottom: 8px; box-sizing: border-box; }
        #startOverlay { position: fixed; inset: 0; background: #0f172a; z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; }
    </style>
</head>
<body>

<div id="startOverlay">
    <h2 style="color:white;">‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢</h2>
    <button id="btnStart" style="padding:15px 40px; background:var(--primary); border:none; border-radius:10px; cursor:pointer; font-weight:600;">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡∏∞‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</button>
</div>

<div class="header" style="text-align:center;">
    <h1 id="villageDisplay" style="color:var(--primary);">Smart Village</h1>
    <div style="display:flex; justify-content:space-around; margin: 20px 0;">
        <div>‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ: <span class="stat-val" id="monthEvents" onclick="location.href='history.html'">0</span></div>
        <div>‡∏õ‡∏µ‡∏ô‡∏µ‡πâ: <span class="stat-val" id="yearEvents" onclick="location.href='history.html'">0</span></div>
    </div>
</div>

<div class="village-grid" id="villageGrid"></div>
<audio id="siren" loop><source src="https://www.soundjay.com/buttons/beep-01a.mp3" type="audio/mpeg"></audio>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, onValue, set, push, serverTimestamp, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBGVarHKqwjhNR_BGANj8CnSWahIHtJNiM",
        authDomain: "village-security-adf63.firebaseapp.com",
        databaseURL: "https://village-security-adf63-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "village-security-adf63",
        storageBucket: "village-security-adf63.firebasestorage.app",
        appId: "1:943368318320:web:7bfb07a8c1db15952233b5"
    };

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);
    const siren = document.getElementById('siren');
    
    let settings = {};
    let localStatus = {}; // ‡πÄ‡∏Å‡πá‡∏ö 'alarm' ‡∏´‡∏£‡∏∑‡∏≠ 'checking'
    let countdowns = {};
    let audioEnabled = false;

    document.getElementById('btnStart').onclick = () => {
        audioEnabled = true;
        document.getElementById('startOverlay').style.display = 'none';
        siren.play().then(() => { siren.pause(); });
    };

    // 1. ‡∏î‡∏∂‡∏á Settings ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏∏‡∏° Theme
    onValue(ref(database, 'Settings'), (snap) => {
        settings = snap.val() || {};
        document.getElementById('villageDisplay').innerText = settings.VillageName || "Smart Village";
        document.body.className = settings.Theme === 'light' ? 'light-mode' : '';
        renderHouses();
    });

    function renderHouses() {
        const grid = document.getElementById('villageGrid');
        grid.innerHTML = "";
        const total = settings.TotalHouses || 10;
        for(let i=1; i<=total; i++) {
            const id = `House${i}`;
            const name = (settings.HouseNames && settings.HouseNames[id]) || `‡∏´‡∏•‡∏±‡∏á‡∏ó‡∏µ‡πà ${i}`;
            grid.innerHTML += `
                <div class="house-card" id="card-${id}">
                    <div style="font-weight:600; font-size:1.2rem;">${name}</div>
                    <div id="status-${id}">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏õ‡∏Å‡∏ï‡∏¥</div>
                    <div id="panel-${id}" style="display:none; margin-top:15px; border-top:1px solid #555; padding-top:10px;">
                        <div id="step1-${id}">
                            <div style="color:var(--warning); font-size:0.8rem; margin-bottom:5px;">SNOOZE (‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß)</div>
                            <div style="display:grid; grid-template-columns:repeat(4,1fr); gap:5px;" id="snzBtns-${id}"></div>
                            <button class="btn-action" style="background:var(--success)" onclick="window.tryClose('${id}')">‡πÅ‡∏à‡πâ‡∏á‡∏ß‡πà‡∏≤‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß</button>
                        </div>
                        <div id="step2-${id}" style="display:none;">
                            <input type="text" id="ins-${id}" class="input-log" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö">
                            <input type="text" id="log-${id}" class="input-log" placeholder="‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏ó‡∏µ‡πà‡∏û‡∏ö">
                            <button class="btn-action" style="background:var(--primary); color:#000;" onclick="window.confirmSave('${id}')">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô</button>
                        </div>
                    </div>
                </div>`;
            
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡∏∏‡πà‡∏° Snooze
            const btnContainer = document.getElementById(`snzBtns-${id}`);
            [5, 15, 30, 60].forEach(t => {
                const b = document.createElement('button');
                b.className = 'btn-snz';
                b.innerText = t + '‡∏°.';
                b.onclick = () => window.startSnooze(id, t);
                btnContainer.appendChild(b);
            });
        }
        listenToHouses();
    }

    function listenToHouses() {
        onValue(ref(database, 'Houses'), (snap) => {
            const data = snap.val() || {};
            let sirenActive = false;

            for(let id in data) {
                const val = data[id];
                const card = document.getElementById(`card-${id}`);
                const statusTxt = document.getElementById(`status-${id}`);
                const panel = document.getElementById(`panel-${id}`);
                if(!card) continue;

                // ‡∏•‡∏≠‡∏à‡∏¥‡∏Å: ‡∏ñ‡πâ‡∏≤ Sensor=1 ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î Snooze ‡πÉ‡∏´‡πâ Alarm
                if(val == 1 && localStatus[id] !== 'checking') {
                    localStatus[id] = 'alarm';
                } else if (val == 0 && localStatus[id] !== 'checking') {
                    localStatus[id] = null;
                }

                if(localStatus[id] === 'alarm') {
                    card.className = 'house-card alarm';
                    statusTxt.innerText = "üö® ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô: ‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ö‡∏∏‡∏Å‡∏£‡∏∏‡∏Å!";
                    panel.style.display = 'block';
                    sirenActive = true;
                } else if(localStatus[id] === 'checking') {
                    card.className = 'house-card checking';
                    statusTxt.innerText = "‚ö†Ô∏è ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...";
                    panel.style.display = 'block';
                } else {
                    card.className = 'house-card';
                    statusTxt.innerText = "‚úÖ ‡∏õ‡∏Å‡∏ï‡∏¥";
                    panel.style.display = 'none';
                }
            }
            if(sirenActive && audioEnabled) siren.play().catch(()=>{}); else siren.pause();
        });
    }

    window.startSnooze = (id, mins) => {
        localStatus[id] = 'checking';
        if(countdowns[id]) clearInterval(countdowns[id]);
        let timeLeft = mins * 60;
        
        countdowns[id] = setInterval(() => {
            timeLeft--;
            if(timeLeft <= 0) {
                clearInterval(countdowns[id]);
                get(ref(database, `Houses/${id}`)).then(s => {
                    if(s.val() == 1) {
                        localStatus[id] = 'alarm'; // ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤ Alarm ‡πÉ‡∏´‡∏°‡πà
                        set(ref(database, `Houses/${id}`), 1); // ‡∏Å‡∏£‡∏∞‡∏ï‡∏∏‡πâ‡∏ô Firebase
                    } else {
                        localStatus[id] = null;
                    }
                });
            }
        }, 1000);
        set(ref(database, `Houses/${id}`), 1); // force update UI
    };

    window.tryClose = (id) => {
        get(ref(database, `Houses/${id}`)).then(s => {
            if(s.val() == 1) alert("‚ùå ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏™‡∏≤‡∏¢‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏ó‡∏µ‡πà " + id + " ‡∏¢‡∏±‡∏á‡∏ä‡πá‡∏≠‡∏ï‡∏≠‡∏¢‡∏π‡πà");
            else {
                document.getElementById(`step1-${id}`).style.display = 'none';
                document.getElementById(`step2-${id}`).style.display = 'block';
            }
        });
    };

    window.confirmSave = (id) => {
        const ins = document.getElementById(`ins-${id}`).value;
        const log = document.getElementById(`log-${id}`).value;
        if(!ins || !log) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");

        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å History
        push(ref(database, 'History'), {
            house: id, inspector: ins, log: log, timestamp: serverTimestamp()
        }).then(() => {
            // ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏™‡∏±‡πà‡∏á Reset Firebase ‡πÄ‡∏õ‡πá‡∏ô 0
            set(ref(database, `Houses/${id}`), 0);
            localStatus[id] = null;
            if(countdowns[id]) clearInterval(countdowns[id]);
            alert("‚úÖ ‡∏õ‡∏¥‡∏î‡πÄ‡∏Ñ‡∏™‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
            document.getElementById(`step2-${id}`).style.display = 'none';
            document.getElementById(`step1-${id}`).style.display = 'block';
        });
    };

    // ‡∏ô‡∏±‡∏ö‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥
    onValue(ref(database, 'History'), (snap) => {
        const count = snap.val() ? Object.keys(snap.val()).length : 0;
        document.getElementById('monthEvents').innerText = count;
        document.getElementById('yearEvents').innerText = count;
    });

</script>
</body>
</html>
