<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Village Monitor</title>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style id="theme-style">
        :root { --danger: #ff4d4d; --primary: #00d4ff; --bg: #0f172a; --card: rgba(30, 41, 59, 0.7); --text: #fff; }
        .light-mode { --bg: #f1f5f9; --card: #ffffff; --text: #1e293b; --primary: #0284c7; }
        
        body { font-family: 'Prompt', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 15px; transition: 0.5s; }
        .header { text-align: center; margin-bottom: 20px; }
        .village-title { font-size: 1.8rem; font-weight: 600; color: var(--primary); margin: 0; }
        
        .stats-bar { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin: 15px 0; }
        .stat-card { background: var(--card); padding: 10px; border-radius: 12px; text-align: center; border: 1px solid rgba(0,0,0,0.1); box-shadow: 0 2px 5px rgba(0,0,0,0.1); cursor: pointer; }
        .stat-val { font-size: 1.2rem; font-weight: 600; color: var(--primary); display: block; }

        #quickAlert { display: none; background: var(--danger); color: white; padding: 12px; border-radius: 10px; margin-bottom: 15px; text-align: center; font-weight: 600; cursor: pointer; sticky: top; }

        .village-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; }
        .house-card { background: var(--card); border-radius: 15px; padding: 15px; border: 2px solid transparent; transition: 0.3s; position: relative; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .house-card.alarm { border-color: var(--danger); animation: pulse 2s infinite; }
        
        .house-main { display: flex; align-items: center; gap: 15px; }
        .house-icon { font-size: 2rem; color: var(--primary); }
        .alarm .house-icon { color: var(--danger); animation: shake 0.5s infinite; }

        /* ‡πÅ‡∏ú‡∏á‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏° Inline */
        .controls-panel { display: none; margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(0,0,0,0.1); }
        .alarm .controls-panel { display: block; }
        .snooze-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; margin-bottom: 10px; }
        .btn-snz { padding: 8px 2px; border: none; border-radius: 5px; background: #f1c40f; font-size: 0.75rem; font-weight: 600; cursor: pointer; }
        .btn-solve { width: 100%; padding: 10px; border: none; border-radius: 8px; background: #2ecc71; color: white; font-weight: 600; cursor: pointer; margin-top: 5px; }
        
        .solve-box { display: none; margin-top: 10px; }
        .input-log { width: 100%; padding: 8px; border-radius: 5px; border: 1px solid #ccc; margin-bottom: 5px; box-sizing: border-box; }
        
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255, 77, 77, 0.4); } 70% { box-shadow: 0 0 0 15px rgba(255, 77, 77, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 77, 77, 0); } }
        @keyframes shake { 0%, 100% { transform: rotate(0); } 25% { transform: rotate(5deg); } 75% { transform: rotate(-5deg); } }
    </style>
</head>
<body>

    <div class="header">
        <h1 class="village-title" id="villageDisplay">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</h1>
        <div class="stats-bar">
            <div class="stat-card"><span>‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢</span><span class="stat-val" id="safeDays">0 ‡∏ß‡∏±‡∏ô</span></div>
            <div class="stat-card"><span>‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</span><span class="stat-val" id="monthEvents">0 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</span></div>
            <div class="stat-card"><span>‡∏õ‡∏µ‡∏ô‡∏µ‡πâ</span><span class="stat-val" id="yearEvents">0 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</span></div>
        </div>
    </div>

    <div id="quickAlert" onclick="scrollToAlarm()">üö® ‡∏ö‡∏∏‡∏Å‡∏£‡∏∏‡∏Å: <span id="alertList"></span></div>
    <div class="village-grid" id="villageGrid"></div>
    <audio id="siren" loop src="https://www.soundjay.com/buttons/beep-01a.mp3"></audio>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, onValue, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBGVarHKqwjhNR_BGANj8CnSWahIHtJNiM",
        authDomain: "village-security-adf63.firebaseapp.com",
        databaseURL: "https://village-security-adf63-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "village-security-adf63",
        storageBucket: "village-security-adf63.firebasestorage.app",
        appId: "1:943368318320:web:7bfb07a8c1db15952233b5"
    };

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);
    let settings = {};
    let currentHousesData = {};

    // 1. ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ò‡∏µ‡∏° (Auto Sunrise-Sunset)
    function updateTheme(mode) {
        if(mode === 'light') document.body.className = 'light-mode';
        else if(mode === 'dark') document.body.className = '';
        else {
            const hour = new Date().getHours();
            // ‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏ß‡∏•‡∏≤ 06:00 - 18:00 ‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô
            document.body.className = (hour >= 6 && hour < 18) ? 'light-mode' : '';
        }
    }
    setInterval(() => settings.Theme === 'auto' && updateTheme('auto'), 60000);

    // 2. ‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤
    onValue(ref(database, 'Settings'), (snap) => {
        settings = snap.val() || {};
        document.getElementById('villageDisplay').innerText = settings.VillageName || "Smart Village";
        updateTheme(settings.Theme);
        renderHouses();
    });

    function renderHouses() {
        const grid = document.getElementById('villageGrid'); grid.innerHTML = "";
        for(let i=1; i<=settings.TotalHouses; i++){
            const id = `House${i}`;
            const name = (settings.HouseNames && settings.HouseNames[id]) || `‡∏´‡∏•‡∏±‡∏á‡∏ó‡∏µ‡πà ${i}`;
            grid.innerHTML += `
                <div class="house-card" id="card-${id}">
                    <div class="house-main">
                        <i class="fas fa-house-damage house-icon"></i>
                        <div><div style="font-weight:600">${name}</div><small id="status-${id}">‡∏õ‡∏Å‡∏ï‡∏¥</small></div>
                    </div>
                    <div class="controls-panel">
                        <div class="snooze-grid">${(settings.SnoozeTimes || [5,15,30,60]).map(t => `<button class="btn-snz" onclick="alert('‡∏û‡∏±‡∏Å ${t} ‡∏ô‡∏≤‡∏ó‡∏µ')">${t} ‡∏°.</button>`).join('')}</div>
                        <div id="solve-area-${id}">
                            <button class="btn-solve" onclick="validateResolve('${id}')">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß</button>
                        </div>
                        <div id="log-area-${id}" class="solve-box">
                            <input type="text" id="log-${id}" class="input-log" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏/‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç...">
                            <button class="btn-solve" onclick="confirmClose('${id}')" style="background:#3498db">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏õ‡∏¥‡∏î‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå</button>
                        </div>
                    </div>
                </div>`;
        }
        listenStatus();
    }

    function listenStatus() {
        onValue(ref(database, 'Houses'), (snap) => {
            currentHousesData = snap.val() || {};
            let alerts = [];
            Object.keys(currentHousesData).forEach(id => {
                const card = document.getElementById('card-'+id);
                if(!card) return;
                if(currentHousesData[id] == 1) {
                    card.classList.add('alarm'); alerts.push((settings.HouseNames && settings.HouseNames[id]) || id);
                } else { card.classList.remove('alarm'); }
            });
            document.getElementById('quickAlert').style.display = alerts.length ? 'block' : 'none';
            document.getElementById('alertList').innerText = alerts.join(', ');
            if(alerts.length) document.getElementById('siren').play().catch(()=>{}); else document.getElementById('siren').pause();
        });
    }

    // ‡∏•‡∏≠‡∏à‡∏¥‡∏Å‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Arduino
    window.validateResolve = (id) => {
        if(currentHousesData[id] == 1) {
            alert("‚ùå ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢! ‡∏ö‡∏≠‡∏£‡πå‡∏î‡πÅ‡∏à‡πâ‡∏á‡∏ß‡πà‡∏≤‡∏™‡∏≤‡∏¢‡∏¢‡∏±‡∏á‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ö‡∏∏‡∏Å‡∏£‡∏∏‡∏Å‡∏≠‡∏¢‡∏π‡πà ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô");
        } else {
            document.getElementById('solve-area-'+id).style.display = 'none';
            document.getElementById('log-area-'+id).style.display = 'block';
        }
    };

    window.confirmClose = (id) => {
        const logText = document.getElementById('log-'+id).value;
        if(!logText) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡πà‡∏≠‡∏ô‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô");
        alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏•‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß");
        // ‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏Å‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏ö History ‡πÉ‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ï‡πà‡∏≠‡πÑ‡∏õ
        document.getElementById('log-area-'+id).style.display = 'none';
        document.getElementById('solve-area-'+id).style.display = 'block';
    };

    window.scrollToAlarm = () => {
        const first = document.querySelector('.house-card.alarm');
        if(first) first.scrollIntoView({ behavior: 'smooth', block: 'center' });
    };
</script>
</body>
</html>
