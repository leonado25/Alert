<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Village Security Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏µ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö 2 ‡πÇ‡∏´‡∏°‡∏î */
        :root { 
            --danger: #ff4d4d; --primary: #00d4ff; --warning: #f1c40f; --success: #2ecc71; 
            --bg: #0f172a; --card: rgba(30, 41, 59, 0.7); --text: #fff; --border: rgba(255,255,255,0.1);
        }

        /* ‡∏Ñ‡∏•‡∏≤‡∏™‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Light Mode */
        .light-mode { 
            --bg: #f1f5f9; --card: #ffffff; --text: #1e293b; --primary: #0284c7; --border: rgba(0,0,0,0.1);
        }

        body { 
            font-family: 'Prompt', sans-serif; background: var(--bg); color: var(--text); 
            margin: 0; padding: 15px; transition: background 0.5s, color 0.5s; overflow-x: hidden; 
        }
        
        .header { text-align: center; margin-bottom: 20px; }
        .village-title { font-size: 1.8rem; font-weight: 600; color: var(--primary); margin: 0; }
        
        .stats-bar { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin: 15px 0; }
        .stat-card { background: var(--card); padding: 10px; border-radius: 12px; text-align: center; border: 1px solid var(--border); }
        .stat-val { font-size: 1.2rem; font-weight: 600; color: var(--primary); display: block; }
        
        #quickAlert { display: none; background: var(--danger); color: white; padding: 12px; border-radius: 10px; margin-bottom: 15px; text-align: center; font-weight: 600; cursor: pointer; position: sticky; top: 10px; z-index: 999; }
        
        .village-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; }
        .house-card { background: var(--card); border-radius: 15px; padding: 15px; border: 2px solid transparent; transition: 0.3s; position: relative; box-shadow: 0 4px 15px rgba(0,0,0,0.1); color: var(--text); }
        
        .house-card.alarm { border-color: var(--danger); background: rgba(255, 77, 77, 0.15); }
        .house-card.checking { border-color: var(--warning); background: rgba(241, 196, 15, 0.15); }
        
        .house-main { display: flex; align-items: center; gap: 15px; }
        .house-icon-container { font-size: 2.2rem; min-width: 50px; text-align: center; }
        .house-icon { color: var(--primary); }
        .alarm .house-icon { color: var(--danger); animation: shake 0.5s infinite; }
        .checking .house-icon { color: var(--warning); }
        
        .controls-panel { display: none; margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border); }
        .alarm .controls-panel, .checking .controls-panel { display: block; }
        
        .snooze-title { font-size: 0.85rem; font-weight: 600; margin-bottom: 8px; color: var(--warning); }
        .snooze-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; margin-bottom: 12px; }
        
        .btn-snz { padding: 8px 0; border: none; border-radius: 5px; background: var(--warning); color: #000; font-size: 0.75rem; font-weight: 600; cursor: pointer; }
        .timer-display { font-size: 0.9rem; color: var(--warning); font-weight: 600; margin-bottom: 10px; display: block; background: rgba(0,0,0,0.1); padding: 5px; border-radius: 5px; text-align: center; }
        
        .btn-action { width: 100%; padding: 12px; border: none; border-radius: 8px; color: white; font-weight: 600; cursor: pointer; font-family: 'Prompt'; }
        .btn-solve { background: var(--success); }
        .btn-confirm { background: var(--primary); margin-top: 8px; }
        
        .solve-step-2 { display: none; margin-top: 10px; }
        .input-log { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg); color: var(--text); margin-bottom: 5px; box-sizing: border-box; font-family: 'Prompt'; }
        
        #startOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #0f172a; z-index: 10000; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        
        @keyframes shake { 0%, 100% { transform: rotate(0); } 25% { transform: rotate(5deg); } 75% { transform: rotate(-5deg); } }
    </style>
</head>
<body>

    <div id="startOverlay">
        <i class="fas fa-shield-alt" style="font-size: 5rem; color: var(--primary); margin-bottom: 20px;"></i>
        <h2 style="color:white; margin-bottom:20px;">‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢</h2>
        <button id="btnStart" style="padding:15px 40px; font-size:1.2rem; background:var(--primary); color:#000; border:none; border-radius:10px; cursor:pointer; font-family:'Prompt'; font-weight:600;">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</button>
    </div>

    <div class="header">
        <h1 class="village-title" id="villageDisplay">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</h1>
        <div class="stats-bar">
            <div class="stat-card"><span>‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢</span><span class="stat-val" id="safeDays">0 ‡∏ß‡∏±‡∏ô</span></div>
            <div class="stat-card"><span>‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</span><span class="stat-val" id="monthEvents">0 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</span></div>
            <div class="stat-card"><span>‡∏õ‡∏µ‡∏ô‡∏µ‡πâ</span><span class="stat-val" id="yearEvents">0 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</span></div>
        </div>
    </div>

    <div id="quickAlert" onclick="scrollToAlarm()">üö® ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô: <span id="alertList"></span></div>
    <div class="village-grid" id="villageGrid"></div>
    <audio id="siren" loop preload="auto"><source src="https://www.soundjay.com/buttons/beep-01a.mp3" type="audio/mpeg"></audio>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, onValue, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBGVarHKqwjhNR_BGANj8CnSWahIHtJNiM",
        authDomain: "village-security-adf63.firebaseapp.com",
        databaseURL: "https://village-security-adf63-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "village-security-adf63",
        storageBucket: "village-security-adf63.firebasestorage.app",
        appId: "1:943368318320:web:7bfb07a8c1db15952233b5"
    };

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);
    let settings = {};
    let localStatus = {}; 
    let countdowns = {};
    let audioEnabled = false;

    // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ò‡∏µ‡∏° ---
    function applyTheme(themeMode) {
        const body = document.body;
        if (themeMode === 'light') {
            body.classList.add('light-mode');
        } else if (themeMode === 'dark') {
            body.classList.remove('light-mode');
        } else if (themeMode === 'auto') {
            const hour = new Date().getHours();
            // ‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô 06:00 - 18:00
            if (hour >= 6 && hour < 18) {
                body.classList.add('light-mode');
            } else {
                body.classList.remove('light-mode');
            }
        }
    }

    document.getElementById('btnStart').addEventListener('click', () => {
        const siren = document.getElementById('siren');
        siren.play().then(() => { 
            siren.pause(); 
            siren.currentTime = 0; 
            audioEnabled = true; 
            document.getElementById('startOverlay').style.display = 'none'; 
        });
    });

    // ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ (‡∏£‡∏ß‡∏°‡∏ñ‡∏∂‡∏á Theme)
    onValue(ref(database, 'Settings'), (snap) => {
        const newSettings = snap.val() || {};
        
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÑ‡∏´‡∏° ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÉ‡∏´‡πâ Render ‡πÉ‡∏´‡∏°‡πà
        if (settings.TotalHouses !== newSettings.TotalHouses) {
            settings = newSettings;
            renderHouses();
        } else {
            settings = newSettings;
        }

        document.getElementById('villageDisplay').innerText = settings.VillageName || "Smart Village";
        
        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ò‡∏µ‡∏°
        applyTheme(settings.Theme);
    });

    function renderHouses() {
        const grid = document.getElementById('villageGrid'); 
        grid.innerHTML = "";
        for(let i=1; i<=settings.TotalHouses; i++){
            const id = `House${i}`;
            const name = (settings.HouseNames && settings.HouseNames[id]) || `‡∏´‡∏•‡∏±‡∏á‡∏ó‡∏µ‡πà ${i}`;
            grid.innerHTML += `
                <div class="house-card" id="card-${id}">
                    <div class="house-main">
                        <div class="house-icon-container"><i class="fas fa-home house-icon"></i></div>
                        <div><div style="font-weight:600">${name}</div><small id="txt-${id}">‡∏õ‡∏Å‡∏ï‡∏¥</small></div>
                    </div>
                    <div class="controls-panel">
                        <div id="panel-step-1-${id}">
                            <div class="snooze-title"><i class="fas fa-user-check"></i> ‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß</div>
                            <span id="timer-${id}" class="timer-display" style="display:none;"></span>
                            <div class="snooze-grid">${(settings.SnoozeTimes || [5,15,30,60]).map(t => `<button class="btn-snz" id="btn-snz-${id}-${t}">${t} ‡∏°.</button>`).join('')}</div>
                            <button class="btn-action btn-solve" id="btn-solve-${id}">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß</button>
                        </div>
                        <div id="panel-step-2-${id}" class="solve-step-2">
                            <input type="text" id="log-${id}" class="input-log" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏õ‡∏±‡∏ç‡∏´‡∏≤...">
                            <button class="btn-action btn-confirm" id="btn-confirm-${id}">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏õ‡∏¥‡∏î‡∏£‡∏∞‡∏ö‡∏ö</button>
                        </div>
                    </div>
                </div>`;
        }
        
        // ‡∏ú‡∏π‡∏Å Event ‡∏õ‡∏∏‡πà‡∏°‡∏ï‡πà‡∏≤‡∏á‡πÜ
        for(let i=1; i<=settings.TotalHouses; i++){
            const id = `House${i}`;
            (settings.SnoozeTimes || [5,15,30,60]).forEach(t => { 
                const btn = document.getElementById(`btn-snz-${id}-${t}`);
                if(btn) btn.onclick = () => startChecking(id, t); 
            });
            document.getElementById(`btn-solve-${id}`).onclick = () => tryResolve(id);
            document.getElementById(`btn-confirm-${id}`).onclick = () => finalSave(id);
        }
        listenHouses();
    }

    function listenHouses() {
        onValue(ref(database, 'Houses'), (snap) => {
            const data = snap.val() || {};
            let alerts = [];
            let shouldPlaySiren = false;

            for(let i=1; i<=settings.TotalHouses; i++){
                const id = 'House' + i;
                const card = document.getElementById('card-' + id);
                const txt = document.getElementById('txt-' + id);
                if(!card) continue;

                if(data[id] == 1 && localStatus[id] !== 'checking') {
                    localStatus[id] = 'alarm';
                }

                if(localStatus[id] === 'alarm') {
                    card.className = 'house-card alarm';
                    txt.innerText = "‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô";
                    shouldPlaySiren = true;
                    alerts.push((settings.HouseNames && settings.HouseNames[id]) || '‡∏´‡∏•‡∏±‡∏á‡∏ó‡∏µ‡πà '+i);
                } else if(localStatus[id] === 'checking') {
                    card.className = 'house-card checking';
                    txt.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...";
                    alerts.push((settings.HouseNames && settings.HouseNames[id]) || '‡∏´‡∏•‡∏±‡∏á‡∏ó‡∏µ‡πà '+i);
                } else {
                    card.className = 'house-card';
                    txt.innerText = "‡∏õ‡∏Å‡∏ï‡∏¥";
                }
            }
            document.getElementById('quickAlert').style.display = alerts.length ? 'block' : 'none';
            document.getElementById('alertList').innerText = alerts.join(', ');
            
            const siren = document.getElementById('siren');
            if(shouldPlaySiren && audioEnabled) siren.play().catch(()=>{}); 
            else siren.pause();
        });
    }

    function startChecking(id, minutes) {
        localStatus[id] = 'checking';
        document.getElementById('siren').pause();
        if(countdowns[id]) clearInterval(countdowns[id]);
        let timeLeft = minutes * 60;
        const timerEl = document.getElementById(`timer-${id}`);
        timerEl.style.display = 'block';
        
        countdowns[id] = setInterval(() => {
            let m = Math.floor(timeLeft / 60);
            let s = timeLeft % 60;
            timerEl.innerHTML = `<i class="fas fa-hourglass-half"></i> ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏ß‡∏•‡∏≤: ${m}:${s < 10 ? '0' : ''}${s}`;
            
            if (timeLeft <= 0) {
                clearInterval(countdowns[id]);
                timerEl.style.display = 'none';
                get(ref(database, 'Houses/'+id)).then((snap) => {
                    if(snap.val() == 1) delete localStatus[id];
                });
            }
            timeLeft--;
        }, 1000);
    }

    function tryResolve(id) {
        get(ref(database, 'Houses/'+id)).then((snap) => {
            if(snap.val() == 1) alert("‚ùå ‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏õ‡∏Å‡∏ï‡∏¥! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏ö‡πâ‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏ô‡∏µ‡πâ");
            else { 
                document.getElementById('panel-step-1-'+id).style.display = 'none'; 
                document.getElementById('panel-step-2-'+id).style.display = 'block'; 
            }
        });
    }

    function finalSave(id) {
        const logText = document.getElementById('log-'+id).value;
        if(!logText.trim()) { alert("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏"); return; }
        alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
        delete localStatus[id];
        if(countdowns[id]) clearInterval(countdowns[id]);
        document.getElementById(`timer-${id}`).style.display = 'none';
        document.getElementById('panel-step-2-'+id).style.display = 'none';
        document.getElementById('panel-step-1-'+id).style.display = 'block';
        document.getElementById('log-'+id).value = "";
    }

    window.scrollToAlarm = () => {
        const el = document.querySelector('.alarm, .checking');
        if(el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
    };
</script>
</body>
</html>
