<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏†‡∏±‡∏¢ - Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root { --safe: #2ecc71; --danger: #e74c3c; --bg: #0f172a; --card: #1e293b; --text: #f8fafc; }
        body { font-family: 'Prompt', sans-serif; background: var(--bg); color: var(--text); margin: 0; transition: 0.3s; }
        
        .header { background: var(--card); padding: 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #334155; }
        .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 20px; padding: 20px; }
        
        .house-card { background: var(--card); border-radius: 15px; padding: 25px; text-align: center; border-bottom: 6px solid var(--safe); transition: 0.3s; }
        
        /* ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏µ‡πÅ‡∏î‡∏á‡∏Å‡∏∞‡∏û‡∏£‡∏¥‡∏ö */
        .house-card.alert-active { border-bottom-color: var(--danger); animation: blink-bg 1s infinite; }
        
        @keyframes blink-bg { 
            0%, 100% { background: var(--card); } 
            50% { background: #450a0a; } 
        }

        .btn { border: none; padding: 10px; border-radius: 8px; cursor: pointer; font-weight: 600; width: 100%; margin-top: 10px; font-family: 'Prompt'; }
        .btn-snooze { background: #64748b; color: white; }
        .btn-close { background: var(--safe); color: white; }
        
        #clock { font-size: 1.5rem; font-weight: 600; color: #00d4ff; }
        .alert-label { color: #ff4d4d; font-weight: bold; font-size: 1.1rem; display: block; margin-top: 10px; }
    </style>
</head>
<body>

<div class="header">
    <h1 id="villageTitle" style="margin:0; font-size: 1.5rem;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</h1>
    <div id="clock">00:00:00</div>
</div>

<div id="dashboard" class="grid-container">
    </div>

<audio id="sirenSound" loop>
    <source src="https://www.soundjay.com/buttons/beep-01a.mp3" type="audio/mpeg">
</audio>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, onValue, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBGVarHKqwjhNR_BGANj8CnSWahIHtJNiM",
        authDomain: "village-security-adf63.firebaseapp.com",
        databaseURL: "https://village-security-adf63-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "village-security-adf63",
        storageBucket: "village-security-adf63.firebasestorage.app",
        appId: "1:943368318320:web:7bfb07a8c1db15952233b5"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let settings = {};
    let isSnoozed = false;
    let snoozeTimer = null;

    // 1. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ (Settings)
    onValue(ref(db, 'Settings'), (snapshot) => {
        settings = snapshot.val() || {};
        document.getElementById('villageTitle').innerText = settings.VillageName || "‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢";
        renderDashboard(); 
    });

    // 2. ‡∏î‡∏∂‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏ö‡∏ö Real-time (Status)
    function renderDashboard() {
        onValue(ref(db, 'Status'), (snapshot) => {
            const statuses = snapshot.val() || {};
            const container = document.getElementById('dashboard');
            container.innerHTML = '';
            
            let hasGlobalAlert = false;
            const total = settings.TotalHouses || 0;

            for (let i = 1; i <= total; i++) {
                const houseId = "House" + i;
                const houseName = (settings.HouseNames && settings.HouseNames[houseId]) || "‡∏ö‡πâ‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏ó‡∏µ‡πà " + i;
                const state = statuses[houseId] || {};

                // ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô: ‡∏ñ‡πâ‡∏≤ panic ‡∏´‡∏£‡∏∑‡∏≠ check ‡πÄ‡∏õ‡πá‡∏ô true (Logic ‡∏ï‡∏¥‡∏î‡∏Ñ‡πâ‡∏≤‡∏á)
                const isAlerting = state.panic === true || state.check === true;
                if (isAlerting) hasGlobalAlert = true;

                const card = document.createElement('div');
                card.className = `house-card ${isAlerting ? 'alert-active' : ''}`;
                
                card.innerHTML = `
                    <small style="color:#94a3b8;">${houseId}</small>
                    <h3 style="margin:5px 0;">${houseName}</h3>
                    ${isAlerting ? `
                        <span class="alert-label">üö® ${state.message || '‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏'}</span>
                        <button class="btn btn-snooze" onclick="window.triggerSnooze()">‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß</button>
                        <button class="btn btn-close" onclick="window.confirmClear('${houseId}')">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</button>
                    ` : '<span style="color:#2ecc71;">‚úÖ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏Å‡∏ï‡∏¥</span>'}
                `;
                container.appendChild(card);
            }

            manageSiren(hasGlobalAlert);
        });
    }

    // --- ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢‡∏á ---
    function manageSiren(isActive) {
        const siren = document.getElementById('sirenSound');
        if (isActive && !isSnoozed) {
            siren.play().catch(() => { console.log("‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏¥‡∏Å‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏™‡∏µ‡∏¢‡∏á"); });
        } else {
            siren.pause();
        }
    }

    // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Snooze (‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ) ---
    window.triggerSnooze = () => {
        isSnoozed = true;
        manageSiren(true); 
        
        const sec = settings.SnoozeTime || 30; // ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å Settings/SnoozeTime
        
        clearTimeout(snoozeTimer);
        snoozeTimer = setTimeout(() => {
            isSnoozed = false;
            // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏£‡∏ö‡πÄ‡∏ß‡∏•‡∏≤ ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà‡∏´‡∏≤‡∏Å‡∏¢‡∏±‡∏á‡∏°‡∏µ‡πÄ‡∏´‡∏ï‡∏∏‡∏Ñ‡πâ‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà
        }, sec * 1000);
        
        alert(`‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÑ‡∏ã‡πÄ‡∏£‡∏ô‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß ${sec} ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ`);
    };

    // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö (‡∏õ‡∏¥‡∏î‡∏à‡πä‡∏≠‡∏ö) ---
    window.confirmClear = (id) => {
        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ñ‡πà‡∏≤‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô false ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
        const updates = {};
        updates[`Status/${id}/panic`] = false;
        updates[`Status/${id}/check`] = false;
        updates[`Status/${id}/message`] = "‡∏õ‡∏Å‡∏ï‡∏¥";

        update(ref(db), updates).then(() => {
            alert(`‡∏ö‡πâ‡∏≤‡∏ô ${id} ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏π‡πà‡∏õ‡∏Å‡∏ï‡∏¥`);
        });
    };

    // ‡∏ô‡∏≤‡∏¨‡∏¥‡∏Å‡∏≤‡πÅ‡∏ö‡∏ö‡πÑ‡∏ó‡∏¢
    setInterval(() => {
        document.getElementById('clock').innerText = new Date().toLocaleTimeString('th-TH');
    }, 1000);
</script>
</body>
</html>
