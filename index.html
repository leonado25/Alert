<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, onValue, get, push } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBGVarHKqwjhNR_BGANj8CnSWahIHtJNiM",
  authDomain: "village-security-adf63.firebaseapp.com",
  databaseURL: "https://village-security-adf63-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "village-security-adf63",
  storageBucket: "village-security-adf63.firebasestorage.app",
  appId: "1:943368318320:web:7bfb07a8c1db15952233b5"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let settings = {};
let localState = {};   // alarm | checking | ready | normal
let countdowns = {};
let audioEnabled = false;

const siren = document.getElementById('siren');

document.getElementById('btnStart').onclick = () => {
  siren.play().then(() => {
    siren.pause();
    siren.currentTime = 0;
    audioEnabled = true;
    document.getElementById('startOverlay').style.display = 'none';
  });
};

/* ---------------- SETTINGS ---------------- */
onValue(ref(db, 'Settings'), snap => {
  settings = snap.val() || {};
  document.getElementById('villageDisplay').innerText =
    settings.VillageName || 'Smart Village';
  renderHouses();
});

/* ---------------- RENDER ---------------- */
function renderHouses() {
  const grid = document.getElementById('villageGrid');
  grid.innerHTML = '';

  for (let i = 1; i <= settings.TotalHouses; i++) {
    const id = `House${i}`;
    const name = settings.HouseNames?.[id] || `หลังที่ ${i}`;

    grid.innerHTML += `
      <div class="house-card" id="card-${id}">
        <div class="house-main">
          <div class="house-icon-container">
            <i class="fas fa-home house-icon"></i>
          </div>
          <div>
            <div style="font-weight:600">${name}</div>
            <small id="txt-${id}">ปกติ</small>
          </div>
        </div>

        <div class="controls-panel">
          <div id="panel1-${id}">
            <div class="snooze-title">
              <i class="fas fa-user-check"></i> ปิดเสียงชั่วคราว
            </div>
            <span id="timer-${id}" class="timer-display" style="display:none"></span>
            <div class="snooze-grid">
              ${(settings.SnoozeTimes || [5,15,30,60])
                .map(t => `<button class="btn-snz" id="snz-${id}-${t}">${t} ม.</button>`)
                .join('')}
            </div>
            <button class="btn-action btn-solve" id="solve-${id}">
              ตรวจสอบและแก้ไขแล้ว
            </button>
          </div>

          <div id="panel2-${id}" class="solve-step-2">
            <input class="input-log" id="log-${id}" placeholder="สาเหตุที่พบ">
            <button class="btn-action btn-confirm" id="confirm-${id}">
              บันทึกและปิดเคส
            </button>
          </div>
        </div>
      </div>
    `;
  }

  for (let i = 1; i <= settings.TotalHouses; i++) {
    const id = `House${i}`;
    (settings.SnoozeTimes || [5,15,30,60])
      .forEach(t => document.getElementById(`snz-${id}-${t}`).onclick =
        () => startChecking(id, t));
    document.getElementById(`solve-${id}`).onclick = () => tryResolve(id);
    document.getElementById(`confirm-${id}`).onclick = () => closeCase(id);
  }

  listenSensors();
}

/* ---------------- SENSOR LISTENER ---------------- */
function listenSensors() {
  onValue(ref(db, 'Houses'), snap => {
    const data = snap.val() || {};
    let alerts = [];
    let play = false;

    for (let i = 1; i <= settings.TotalHouses; i++) {
      const id = `House${i}`;
      const sensor = data[id];
      const card = document.getElementById(`card-${id}`);
      const txt = document.getElementById(`txt-${id}`);

      if (!localState[id]) localState[id] = 'normal';

      if (sensor === 1) {
        if (localState[id] === 'normal') localState[id] = 'alarm';
        if (localState[id] === 'checking') {
          /* stay */
        }
        if (localState[id] === 'ready') {
          localState[id] = 'alarm';
        }
      }

      if (sensor === 0 && localState[id] === 'checking') {
        localState[id] = 'ready';
      }

      card.className = 'house-card';

      if (localState[id] === 'alarm') {
        card.classList.add('alarm');
        txt.innerText = 'แจ้งเตือน';
        alerts.push(id);
        play = true;
      }

      if (localState[id] === 'checking') {
        card.classList.add('checking');
        txt.innerText = 'กำลังตรวจสอบ';
        alerts.push(id);
      }

      if (localState[id] === 'ready') {
        card.classList.add('checking');
        txt.innerText = 'แก้ไขแล้ว รอปิดเคส';
        alerts.push(id);
      }

      if (localState[id] === 'normal') {
        txt.innerText = 'ปกติ';
      }
    }

    document.getElementById('quickAlert').style.display =
      alerts.length ? 'block' : 'none';
    document.getElementById('alertList').innerText = alerts.join(', ');

    if (play && audioEnabled) siren.play().catch(()=>{});
    else {
      siren.pause();
      siren.currentTime = 0;
    }
  });
}

/* ---------------- ACTIONS ---------------- */
function startChecking(id, min) {
  if (countdowns[id]) return;
  localState[id] = 'checking';
  siren.pause();

  let t = min * 60;
  const timer = document.getElementById(`timer-${id}`);
  timer.style.display = 'block';

  countdowns[id] = setInterval(() => {
    timer.innerText = `เหลือเวลา ${Math.floor(t/60)}:${(t%60).toString().padStart(2,'0')}`;
    if (t-- <= 0) {
      clearInterval(countdowns[id]);
      countdowns[id] = null;
      timer.style.display = 'none';
      get(ref(db, 'Houses/'+id)).then(snap => {
        if (snap.val() === 1) localState[id] = 'alarm';
      });
    }
  }, 1000);
}

function tryResolve(id) {
  get(ref(db, 'Houses/'+id)).then(snap => {
    if (snap.val() === 1) {
      alert('❌ สัญญาณยังไม่ปกติ ไม่สามารถปิดเคสได้');
    } else {
      document.getElementById(`panel1-${id}`).style.display = 'none';
      document.getElementById(`panel2-${id}`).style.display = 'block';
    }
  });
}

function closeCase(id) {
  const text = document.getElementById(`log-${id}`).value.trim();
  if (!text) return alert('⚠️ กรุณากรอกสาเหตุ');

  push(ref(db, 'History'), {
    house: id,
    reason: text,
    time: new Date().toISOString()
  });

  localState[id] = 'normal';
  document.getElementById(`panel2-${id}`).style.display = 'none';
  document.getElementById(`panel1-${id}`).style.display = 'block';
  document.getElementById(`log-${id}`).value = '';
}
</script>
