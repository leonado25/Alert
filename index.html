<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>Dashboard - ‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢</title>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root { --safe: #2ecc71; --danger: #e74c3c; --bg: #0f172a; --card: #1e293b; --text: #f8fafc; --accent: #00d4ff; --warning: #f1c40f; }
        body { font-family: 'Prompt', sans-serif; background: var(--bg); color: var(--text); margin: 0; }
        
        /* Layout Header */
        .header-main { background: var(--card); border-bottom: 1px solid #334155; position: sticky; top: 0; z-index: 1000; }
        .row-1 { display: flex; justify-content: space-between; align-items: center; padding: 10px 20px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .row-2 { display: flex; justify-content: space-around; padding: 10px; background: rgba(0,0,0,0.2); }
        .row-3-alert { background: var(--danger); color: white; padding: 12px; text-align: center; display: none; font-weight: 600; animation: pulse-red 1.5s infinite; sticky; top: 100px; }
        
        .stat-item { text-decoration: none; color: var(--text); text-align: center; flex: 1; transition: 0.3s; }
        .stat-item:hover { color: var(--accent); transform: scale(1.05); }
        .stat-value { display: block; font-size: 1.4rem; font-weight: 600; }
        .stat-label { font-size: 0.75rem; color: #94a3b8; }

        /* Grid & Cards */
        .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 20px; padding: 20px; }
        .house-card { background: var(--card); border-radius: 15px; padding: 25px; text-align: center; border-bottom: 6px solid var(--safe); transition: 0.5s; }
        .house-card.alert-active { border-bottom-color: var(--danger); box-shadow: 0 0 20px rgba(231, 76, 60, 0.4); }
        .house-card.highlight { outline: 4px solid var(--warning); transform: scale(1.05); }

        /* Modal */
        .modal { display: none; position: fixed; z-index: 10001; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); }
        .modal-content { background: var(--card); margin: 10% auto; padding: 30px; border-radius: 15px; width: 90%; max-width: 450px; }
        .modal-input { width: 100%; padding: 12px; margin: 10px 0; border-radius: 8px; border: 1px solid #334155; background: #0f172a; color: white; font-family: 'Prompt'; box-sizing: border-box; }
        
        #welcomeOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 10002; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .btn { border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: 600; width: 100%; margin-top: 10px; font-family: 'Prompt'; }
        .btn-start { background: var(--accent); color: #0f172a; width: auto; padding: 20px 40px; font-size: 1.5rem; }
        
        @keyframes pulse-red { 0% { background: #e74c3c; } 50% { background: #c0392b; } 100% { background: #e74c3c; } }
        #snoozeInfo { color: var(--warning); font-weight: 600; display: none; margin-right: 15px; }
    </style>
</head>
<body>

<div id="welcomeOverlay">
    <h1 style="font-size: 2.5rem; margin-bottom: 20px;">üõ°Ô∏è ‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢</h1>
    <button class="btn btn-start" onclick="startSystem()">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á</button>
</div>

<div class="header-main">
    <div class="row-1">
        <div id="dateNow" style="font-size: 0.9rem; color: #94a3b8;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
        <h2 id="villageTitle" style="margin:0; color: var(--accent);">‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</h2>
        <div id="clock" style="font-size: 1.3rem; font-weight: 600;">00:00:00</div>
    </div>
    
    <div class="row-2">
        <a href="history.html" class="stat-item">
            <span class="stat-value" id="safeDays">0</span>
            <span class="stat-label">‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß (‡∏ß‡∏±‡∏ô)</span>
        </a>
        <a href="history.html" class="stat-item" style="border-left: 1px solid #334155; border-right: 1px solid #334155;">
            <span class="stat-value" id="monthEvents">0</span>
            <span class="stat-label">‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</span>
        </a>
        <a href="history.html" class="stat-item">
            <span class="stat-value" id="yearEvents">0</span>
            <span class="stat-label">‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏õ‡∏µ‡∏ô‡∏µ‡πâ</span>
        </a>
    </div>

    <div id="alertBar" class="row-3-alert"></div>
</div>

<div id="dashboard" class="grid-container"></div>

<div id="reportModal" class="modal">
    <div class="modal-content">
        <h2 id="modalHouseTitle" style="color:var(--accent);">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</h2>
        <input type="text" id="inspectorName" class="modal-input" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö">
        <textarea id="inspectDetail" class="modal-input" rows="3" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå"></textarea>
        <button class="btn" style="background:var(--safe); color:white;" onclick="submitFinalClear()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô</button>
        <button class="btn" style="background:#4b5563; color:white;" onclick="closeModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
    </div>
</div>

<audio id="sirenSound" loop><source src="https://www.soundjay.com/buttons/beep-01a.mp3" type="audio/mpeg"></audio>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, onValue, update, push, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBGVarHKqwjhNR_BGANj8CnSWahIHtJNiM",
        authDomain: "village-security-adf63.firebaseapp.com",
        databaseURL: "https://village-security-adf63-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "village-security-adf63",
        storageBucket: "village-security-adf63.firebasestorage.app",
        appId: "1:943368318320:web:7bfb07a8c1db15952233b5"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let settings = {}, currentStatuses = {}, isSnoozed = false, activeHouseId = "";

    window.startSystem = () => {
        document.getElementById('welcomeOverlay').style.display = 'none';
        const siren = document.getElementById('sirenSound');
        siren.play().then(() => siren.pause());
    };

    // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥
    onValue(ref(db, 'Settings'), (snap) => {
        settings = snap.val() || {};
        document.getElementById('villageTitle').innerText = settings.VillageName || "Village Security";
    });

    onValue(ref(db, 'AuditLogs'), (snap) => {
        const logs = snap.val() || {};
        calculateStats(logs);
    });

    onValue(ref(db, 'Status'), (snap) => {
        currentStatuses = snap.val() || {};
        renderDashboard();
    });

    function renderDashboard() {
        const container = document.getElementById('dashboard');
        const alertBar = document.getElementById('alertBar');
        container.innerHTML = '';
        let alertingHouses = [];

        for (let i = 1; i <= (settings.TotalHouses || 0); i++) {
            const houseId = "House_" + String(i).padStart(3, '0');
            const houseName = (settings.HouseNames && settings.HouseNames[houseId]) || houseId;
            const state = currentStatuses[houseId] || {};
            const isAlert = state.panic || state.check;

            if (isAlert) alertingHouses.push({id: houseId, name: houseName});

            const card = document.createElement('div');
            card.className = `house-card ${isAlert ? 'alert-active' : ''}`;
            card.id = `card-${houseId}`;
            card.innerHTML = `
                <h3 style="margin:0;">${houseName}</h3>
                ${isAlert ? `
                    <span style="color:var(--danger); font-weight:600; display:block; margin:10px 0;">üö® ${state.message || '‡πÄ‡∏Å‡∏¥‡∏î‡πÄ‡∏´‡∏ï‡∏∏'}</span>
                    <button class="btn" style="background:#64748b; color:white;" onclick="window.triggerSnooze()">‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á</button>
                    <button class="btn" style="background:var(--safe); color:white;" onclick="window.openReport('${houseId}','${houseName}')">‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô</button>
                ` : '<p style="color:var(--safe); margin:15px 0;">‡∏õ‡∏Å‡∏ï‡∏¥</p>'}
            `;
            container.appendChild(card);
        }

        // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏ñ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ó‡∏µ‡πà 3
        if (alertingHouses.length > 0) {
            alertBar.style.display = 'block';
            alertBar.innerHTML = `üö® ‡∏û‡∏ö‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå: ` + alertingHouses.map(h => 
                `<span style="text-decoration:underline; cursor:pointer; margin-left:10px;" onclick="window.jumpToHouse('${h.id}')">${h.name}</span>`
            ).join(', ');
            if (!isSnoozed) document.getElementById('sirenSound').play().catch(() => {});
        } else {
            alertBar.style.display = 'none';
            document.getElementById('sirenSound').pause();
        }
    }

    window.jumpToHouse = (id) => {
        const el = document.getElementById(`card-${id}`);
        el.scrollIntoView({ behavior: 'smooth', block: 'center' });
        el.classList.add('highlight');
        setTimeout(() => el.classList.remove('highlight'), 3000);
    };

    window.triggerSnooze = () => {
        isSnoozed = true;
        document.getElementById('sirenSound').pause();
        let sec = settings.SnoozeTime || 30;
        const timer = setInterval(() => {
            sec--;
            if (sec <= 0) { clearInterval(timer); isSnoozed = false; renderDashboard(); }
        }, 1000);
        alert(`‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß ${settings.SnoozeTime} ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ`);
    };

    window.openReport = (id, name) => {
        const state = currentStatuses[id] || {};
        if (state.panic || state.check) {
            alert("‚ùå ‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ! ‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏à‡∏≤‡∏Å Arduino ‡∏¢‡∏±‡∏á‡∏ä‡πá‡∏≠‡∏ï‡∏≠‡∏¢‡∏π‡πà"); return;
        }
        activeHouseId = id;
        document.getElementById('modalHouseTitle').innerText = name;
        document.getElementById('reportModal').style.display = 'block';
    };

    window.closeModal = () => document.getElementById('reportModal').style.display = 'none';

    window.submitFinalClear = () => {
        const name = document.getElementById('inspectorName').value;
        const detail = document.getElementById('inspectDetail').value;
        if (!name || !detail) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");

        update(ref(db, `Status/${activeHouseId}`), { panic: false, check: false, message: "‡∏õ‡∏Å‡∏ï‡∏¥" }).then(() => {
            push(ref(db, 'AuditLogs'), {
                houseId: activeHouseId,
                inspector: name,
                detail: detail,
                timestamp: Date.now()
            });
            alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
            closeModal();
        });
    };

    function calculateStats(logs) {
        const now = new Date();
        let mCount = 0, yCount = 0, lastEventTime = 0;
        Object.values(logs).forEach(log => {
            const d = new Date(log.timestamp);
            if (d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear()) mCount++;
            if (d.getFullYear() === now.getFullYear()) yCount++;
            if (log.timestamp > lastEventTime) lastEventTime = log.timestamp;
        });
        document.getElementById('monthEvents').innerText = mCount;
        document.getElementById('yearEvents').innerText = yCount;
        const diff = lastEventTime === 0 ? 0 : Math.floor((Date.now() - lastEventTime) / (1000*60*60*24));
        document.getElementById('safeDays').innerText = diff;
    }

    setInterval(() => {
        const d = new Date();
        document.getElementById('clock').innerText = d.toLocaleTimeString('th-TH');
        document.getElementById('dateNow').innerText = d.toLocaleDateString('th-TH', { day:'numeric', month:'short', year:'numeric' });
    }, 1000);
</script>
</body>
</html>
