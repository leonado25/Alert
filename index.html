<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Village Security System - Monitoring</title>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { 
            --primary: #00d4ff; --bg: #0f172a; --card: rgba(30, 41, 59, 0.7); 
            --text: #fff; --danger: #ff4d4d; --success: #2ecc71; --warning: #f1c40f;
        }
        .light-mode { 
            --bg: #f1f5f9; --card: #ffffff; --text: #1e293b; --primary: #0284c7; 
        }

        body { font-family: 'Prompt', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; transition: 0.5s; overflow-x: hidden; }
        .header { text-align: center; margin-bottom: 30px; position: relative; }
        .header h1 { margin: 0; color: var(--primary); text-shadow: 0 0 10px rgba(0, 212, 255, 0.3); }

        /* ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÅ‡∏•‡∏∞‡∏•‡∏¥‡∏á‡∏Å‡πå */
        .stats-bar { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 30px; }
        .stat-card { background: var(--card); padding: 15px; border-radius: 15px; text-align: center; border: 1px solid rgba(255,255,255,0.1); }
        .stat-card span { display: block; font-size: 0.8rem; opacity: 0.8; }
        .stat-val { font-size: 1.4rem; font-weight: 600; color: var(--primary); text-decoration: underline rgba(0, 212, 255, 0.2); cursor: pointer; }

        /* ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ö‡πâ‡∏≤‡∏ô */
        .houses-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; }
        .house-card { background: var(--card); border-radius: 20px; padding: 20px; border: 2px solid transparent; transition: 0.3s; position: relative; }
        .house-card.alert { border-color: var(--danger); animation: pulse-red 2s infinite; }
        .house-card.solving { border-color: var(--warning); }

        .house-info h2 { margin: 0; font-size: 1.5rem; }
        .status-text { font-size: 0.9rem; margin-top: 5px; font-weight: 300; }

        /* ‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• */
        .solve-panel { margin-top: 15px; display: none; }
        .input-log { width: 100%; background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.2); color: white; padding: 10px; border-radius: 8px; font-family: 'Prompt'; margin-bottom: 10px; box-sizing: border-box; }
        .light-mode .input-log { background: #f8fafc; color: #000; border-color: #cbd5e1; }
        
        .btn-action { width: 100%; padding: 12px; border: none; border-radius: 10px; font-family: 'Prompt'; font-weight: 600; cursor: pointer; transition: 0.3s; }
        .btn-solve { background: var(--warning); color: #000; }
        .btn-confirm { background: var(--success); color: #000; }

        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(255, 77, 77, 0.4); } 70% { box-shadow: 0 0 0 15px rgba(255, 77, 77, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 77, 77, 0); } }
    </style>
</head>
<body>

    <div class="header">
        <h1 id="villageDisplay">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</h1>
        <p><i class="fas fa-shield-alt"></i> ‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ 24 ‡∏ä‡∏°.</p>
    </div>

    <div class="stats-bar">
        <div class="stat-card"><span>‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß</span><div class="stat-val" id="safeDays">0 ‡∏ß‡∏±‡∏ô</div></div>
        <div class="stat-card"><span>‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ (‡∏Ñ‡∏£‡∏±‡πâ‡∏á)</span><a href="history.html" style="text-decoration:none;"><div class="stat-val" id="monthEvents">0</div></a></div>
        <div class="stat-card"><span>‡∏õ‡∏µ‡∏ô‡∏µ‡πâ (‡∏Ñ‡∏£‡∏±‡πâ‡∏á)</span><a href="history.html" style="text-decoration:none;"><div class="stat-val" id="yearEvents">0</div></a></div>
    </div>

    <div class="houses-grid" id="housesContainer"></div>

    <audio id="sirenSound" loop>
        <source src="https://www.soundjay.com/buttons/sounds/beep-01a.mp3" type="audio/mpeg">
    </audio>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, onValue, set, update, push, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBGVarHKqwjhNR_BGANj8CnSWahIHtJNiM",
        authDomain: "village-security-adf63.firebaseapp.com",
        databaseURL: "https://village-security-adf63-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "village-security-adf63",
        storageBucket: "village-security-adf63.firebasestorage.app",
        appId: "1:943368318320:web:7bfb07a8c1db15952233b5"
    };

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);
    const siren = document.getElementById('sirenSound');

    let settings = {};
    let eventStartTimes = {}; // ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ö‡πâ‡∏≤‡∏ô

    // 1. ‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏•‡∏∞‡∏ò‡∏µ‡∏°
    onValue(ref(database, 'Settings'), (snap) => {
        settings = snap.val() || {};
        document.getElementById('villageDisplay').innerText = settings.VillageName || "Smart Village";
        
        const mode = settings.Theme || 'dark';
        const hour = new Date().getHours();
        const isDark = mode === 'dark' || (mode === 'auto' && (hour < 6 || hour >= 18));
        document.body.className = isDark ? '' : 'light-mode';
    });

    // 2. ‡∏ü‡∏±‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡πâ‡∏≤‡∏ô (Real-time)
    onValue(ref(database, 'Houses'), (snap) => {
        const houses = snap.val();
        const container = document.getElementById('housesContainer');
        container.innerHTML = '';
        let hasAnyAlert = false;

        for (let id in houses) {
            const h = houses[id];
            const isAlert = h.Status === 1;
            const isSolving = h.Status === 2;
            const houseName = (settings.HouseNames && settings.HouseNames[id]) || `‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà ${id}`;

            if (isAlert) {
                hasAnyAlert = true;
                if (!eventStartTimes[id]) eventStartTimes[id] = new Date().toISOString();
            }

            const card = document.createElement('div');
            card.className = `house-card ${isAlert ? 'alert' : ''} ${isSolving ? 'solving' : ''}`;
            card.innerHTML = `
                <div class="house-info">
                    <h2>${houseName}</h2>
                    <div class="status-text">${isAlert ? 'üö® ‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö‡∏Å‡∏≤‡∏£‡∏ö‡∏∏‡∏Å‡∏£‡∏∏‡∏Å!' : isSolving ? '‚ö†Ô∏è ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...' : '‚úÖ ‡∏õ‡∏Å‡∏ï‡∏¥'}</div>
                </div>
                ${isAlert ? `<button class="btn-action btn-solve" onclick="startSolve('${id}')" style="margin-top:15px;">‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏∞‡∏á‡∏±‡∏ö‡πÄ‡∏´‡∏ï‡∏∏</button>` : ''}
                <div id="panel-${id}" class="solve-panel" style="${isSolving ? 'display:block' : ''}">
                    <input type="text" id="inspector-${id}" class="input-log" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...">
                    <input type="text" id="log-${id}" class="input-log" placeholder="‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏ó‡∏µ‡πà‡∏û‡∏ö...">
                    <button class="btn-action btn-confirm" onclick="finalSave('${id}')">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô</button>
                </div>
            `;
            container.appendChild(card);
        }

        // ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÑ‡∏ã‡πÄ‡∏£‡∏ô
        if (hasAnyAlert) siren.play().catch(e => console.log("‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏Å‡∏î‡∏à‡∏≤‡∏Å User"));
        else siren.pause();
    });

    // 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°
    window.startSolve = (id) => {
        update(ref(database, `Houses/${id}`), { Status: 2 });
    };

    window.finalSave = (id) => {
        const inspector = document.getElementById(`inspector-${id}`).value;
        const log = document.getElementById(`log-${id}`).value;

        if (!inspector || !log) {
            alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡∏Ñ‡πà‡∏∞!");
            return;
        }

        const historyRef = push(ref(database, 'History'));
        set(historyRef, {
            houseName: (settings.HouseNames && settings.HouseNames[id]) || id,
            startTime: eventStartTimes[id] || new Date().toISOString(),
            endTime: new Date().toISOString(),
            inspector: inspector,
            log: log,
            timestamp: serverTimestamp()
        }).then(() => {
            update(ref(database, `Houses/${id}`), { Status: 0 });
            delete eventStartTimes[id];
            alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
        });
    };

    // 4. ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥ (‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô)
    onValue(ref(database, 'History'), (snap) => {
        const data = snap.val();
        if (data) {
            const count = Object.keys(data).length;
            document.getElementById('monthEvents').innerText = count;
            document.getElementById('yearEvents').innerText = count;
        }
    });

</script>
</body>
</html>
