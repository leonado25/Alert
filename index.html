<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>Dashboard - ‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢</title>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root { --safe: #2ecc71; --danger: #e74c3c; --bg: #0f172a; --card: #1e293b; --text: #f8fafc; --accent: #00d4ff; --warning: #f1c40f; }
        body { font-family: 'Prompt', sans-serif; background: var(--bg); color: var(--text); margin: 0; overflow-x: hidden; }
        
        /* Header Layout */
        .header-main { background: var(--card); border-bottom: 1px solid #334155; position: sticky; top: 0; z-index: 1000; }
        .row-1 { display: flex; justify-content: space-between; align-items: center; padding: 10px 20px; }
        .row-2 { display: flex; justify-content: space-around; padding: 10px; background: rgba(0,0,0,0.2); border-top: 1px solid rgba(255,255,255,0.05); }
        .row-3-alert { background: var(--danger); color: white; padding: 12px; text-align: center; display: none; font-weight: 600; animation: pulse-red 1.5s infinite; position: sticky; top: 115px; z-index: 999; cursor: pointer; }
        
        .stat-item { text-decoration: none; color: var(--text); text-align: center; flex: 1; transition: 0.3s; border-right: 1px solid #334155; }
        .stat-item:last-child { border-right: none; }
        .stat-value { display: block; font-size: 1.4rem; font-weight: 600; color: var(--accent); }
        .stat-label { font-size: 0.75rem; color: #94a3b8; }

        /* House Cards */
        .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 20px; padding: 25px; }
        .house-card { background: var(--card); border-radius: 15px; padding: 20px; text-align: center; border-bottom: 6px solid var(--safe); transition: 0.4s; position: relative; }
        .house-card.alert-active { border-bottom-color: var(--danger); box-shadow: 0 0 20px rgba(231, 76, 60, 0.3); }
        .house-card.highlight { outline: 4px solid var(--warning); transform: scale(1.05); z-index: 10; }

        /* Modal & Overlay */
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); backdrop-filter: blur(5px); }
        .modal-content { background: var(--card); margin: 10% auto; padding: 30px; border-radius: 20px; width: 90%; max-width: 400px; border: 1px solid var(--accent); }
        .modal-input { width: 100%; padding: 12px; margin: 10px 0; border-radius: 8px; border: 1px solid #334155; background: #0f172a; color: white; font-family: 'Prompt'; box-sizing: border-box; }
        
        #startOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .btn { border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; font-family: 'Prompt'; transition: 0.2s; }
        .btn-close { background: var(--safe); color: #000; width: 100%; margin-top: 10px; }
        .btn-snooze { background: #64748b; color: white; width: 100%; margin-top: 5px; }
        
        @keyframes pulse-red { 0% { background: #e74c3c; } 50% { background: #c0392b; } 100% { background: #e74c3c; } }
    </style>
</head>
<body>

<div id="startOverlay">
    <h1 style="color: var(--accent);">üõ°Ô∏è ‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢</h1>
    <button class="btn" style="background:var(--accent); padding: 20px 40px; font-size: 1.2rem;" onclick="initSystem()">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á</button>
</div>

<div class="header-main">
    <div class="row-1">
        <div id="dateNow" style="color: #94a3b8;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
        <h2 id="villageTitle" style="margin:0; color: var(--accent);">VILLAGE SECURITY</h2>
        <div id="clock" style="font-size: 1.2rem; font-weight: 600;">00:00:00</div>
    </div>
    
    <div class="row-2">
        <a href="history.html" class="stat-item">
            <span class="stat-value" id="safeDays">0</span>
            <span class="stat-label">‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß (‡∏ß‡∏±‡∏ô)</span>
        </a>
        <a href="history.html" class="stat-item">
            <span class="stat-value" id="monthEvents">0</span>
            <span class="stat-label">‡πÄ‡∏´‡∏ï‡∏∏‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</span>
        </a>
        <a href="history.html" class="stat-item">
            <span class="stat-value" id="yearEvents">0</span>
            <span class="stat-label">‡πÄ‡∏´‡∏ï‡∏∏‡∏õ‡∏µ‡∏ô‡∏µ‡πâ</span>
        </a>
    </div>
    <div id="alertBar" class="row-3-alert"></div>
</div>

<div id="dashboard" class="grid-container"></div>

<div id="closeJobModal" class="modal">
    <div class="modal-content">
        <h3 id="modalTitle">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô</h3>
        <p id="modalHouse" style="color: var(--accent); font-weight: 600;"></p>
        <input type="text" id="inspector" class="modal-input" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö">
        <textarea id="finding" class="modal-input" rows="3" placeholder="‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö / ‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏"></textarea>
        <button class="btn btn-close" onclick="saveAndCloseJob()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô</button>
        <button class="btn btn-snooze" style="background:#4b5563;" onclick="closeModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
    </div>
</div>

<audio id="siren" loop><source src="https://www.soundjay.com/buttons/beep-01a.mp3" type="audio/mpeg"></audio>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, onValue, update, push, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBGVarHKqwjhNR_BGANj8CnSWahIHtJNiM",
        authDomain: "village-security-adf63.firebaseapp.com",
        databaseURL: "https://village-security-adf63-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "village-security-adf63",
        appId: "1:943368318320:web:7bfb07a8c1db15952233b5"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let housesStatus = {}, settings = {}, isSnoozed = false, currentModalId = null;

    window.initSystem = () => {
        document.getElementById('startOverlay').style.display = 'none';
        document.getElementById('siren').play().then(() => document.getElementById('siren').pause());
    };

    onValue(ref(db, 'Settings'), s => { 
        settings = s.val() || { VillageName: "My Village", TotalHouses: 20, SnoozeTime: 30 };
        document.getElementById('villageTitle').innerText = settings.VillageName;
    });

    onValue(ref(db, 'AuditLogs'), s => calculateStats(s.val() || {}));

    onValue(ref(db, 'Status'), snap => {
        housesStatus = snap.val() || {};
        updateUI();
    });

    function updateUI() {
        const grid = document.getElementById('dashboard');
        const alertBar = document.getElementById('alertBar');
        grid.innerHTML = '';
        let alerts = [];

        for(let i=1; i <= settings.TotalHouses; i++) {
            let id = "House_" + String(i).padStart(3, '0');
            let data = housesStatus[id] || {};
            let isAlert = data.is_alerting === true;

            if(isAlert) alerts.push({id, name: (settings.HouseNames && settings.HouseNames[id]) || id});

            let card = document.createElement('div');
            card.className = `house-card ${isAlert ? 'alert-active' : ''}`;
            card.id = `card-${id}`;
            card.innerHTML = `
                <div style="font-size:1.2rem; font-weight:600;">${(settings.HouseNames && settings.HouseNames[id]) || id}</div>
                ${isAlert ? `
                    <p style="color:var(--danger); font-weight:600; margin:10px 0;">üö® ${data.message || '‡πÄ‡∏Å‡∏¥‡∏î‡πÄ‡∏´‡∏ï‡∏∏'}</p>
                    <p style="font-size:0.8rem; color:#94a3b8;">‡πÄ‡∏£‡∏¥‡πà‡∏°: ${data.start_time ? new Date(data.start_time).toLocaleTimeString('th-TH') : '-'}</p>
                    <button class="btn btn-snooze" onclick="snoozeAlert()">‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß</button>
                    <button class="btn btn-close" onclick="openCloseJobModal('${id}')">‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô</button>
                ` : '<p style="color:var(--safe); margin:15px 0;">‡∏õ‡∏Å‡∏ï‡∏¥</p>'}
            `;
            grid.appendChild(card);
        }

        if(alerts.length > 0) {
            alertBar.style.display = 'block';
            alertBar.innerHTML = `üö® ‡πÄ‡∏Å‡∏¥‡∏î‡πÄ‡∏´‡∏ï‡∏∏ (${alerts.length} ‡∏´‡∏•‡∏±‡∏á): ` + alerts.map(a => `<span onclick="jumpTo('${a.id}')" style="text-decoration:underline; margin:0 5px;">${a.name}</span>`).join('');
            if(!isSnoozed) document.getElementById('siren').play();
        } else {
            alertBar.style.display = 'none';
            document.getElementById('siren').pause();
        }
    }

    window.snoozeAlert = () => {
        isSnoozed = true;
        document.getElementById('siren').pause();
        setTimeout(() => { isSnoozed = false; updateUI(); }, (settings.SnoozeTime || 30) * 1000);
    };

    window.jumpTo = (id) => {
        const el = document.getElementById(`card-${id}`);
        el.scrollIntoView({behavior: 'smooth', block: 'center'});
        el.classList.add('highlight');
        setTimeout(() => el.classList.remove('highlight'), 3000);
    };

    window.openCloseJobModal = (id) => {
        if(housesStatus[id].contact_status === true) {
            alert("‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ! ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà " + id + " ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô");
            return;
        }
        currentModalId = id;
        document.getElementById('modalHouse').innerText = "‡∏ö‡πâ‡∏≤‡∏ô: " + id;
        document.getElementById('closeJobModal').style.display = 'block';
    };

    window.closeModal = () => document.getElementById('closeJobModal').style.display = 'none';

    window.saveAndCloseJob = () => {
        const name = document.getElementById('inspector').value;
        const detail = document.getElementById('finding').value;
        if(!name || !detail) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");

        const logRef = ref(db, 'AuditLogs');
        const houseData = housesStatus[currentModalId];
        
        push(logRef, {
            houseId: currentModalId,
            eventType: houseData.event_type,
            startTime: houseData.start_time,
            endTime: Date.now(),
            inspector: name,
            detail: detail
        }).then(() => {
            update(ref(db, `Status/${currentModalId}`), { is_alerting: false, message: "‡∏õ‡∏Å‡∏ï‡∏¥" });
            closeModal();
            alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡∏∞‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
        });
    };

    function calculateStats(logs) {
        const now = new Date();
        let m = 0, y = 0, last = 0;
        Object.values(logs).forEach(l => {
            let d = new Date(l.endTime);
            if(d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear()) m++;
            if(d.getFullYear() === now.getFullYear()) y++;
            if(l.endTime > last) last = l.endTime;
        });
        document.getElementById('monthEvents').innerText = m;
        document.getElementById('yearEvents').innerText = y;
        document.getElementById('safeDays').innerText = last === 0 ? 0 : Math.floor((Date.now() - last)/(1000*60*60*24));
    }

    setInterval(() => {
        const n = new Date();
        document.getElementById('clock').innerText = n.toLocaleTimeString('th-TH');
        document.getElementById('dateNow').innerText = n.toLocaleDateString('th-TH', {day:'numeric', month:'short', year:'numeric'});
    }, 1000);
</script>
</body>
</html>

