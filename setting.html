<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ตั้งค่าระบบ - Village Security Command Center</title>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary: #00d4ff; --save: #2ecc71; --bg: #0f172a; --card: rgba(30, 41, 59, 0.9); --accent: #f1c40f; }
        body { font-family: 'Prompt', sans-serif; background: #0b0f19; color: #f8fafc; padding: 20px; line-height: 1.6; }
        .container { max-width: 850px; margin: 0 auto; padding-bottom: 50px; }
        
        h1 { border-bottom: 1px solid #334155; padding-bottom: 15px; font-weight: 400; letter-spacing: 1px; color: var(--primary); }
        .section-card { background: var(--card); border-radius: 15px; padding: 25px; margin-bottom: 20px; border-left: 5px solid transparent; transition: 0.3s; position: relative; }
        .section-card.changed { border-left-color: var(--accent); box-shadow: 0 0 15px rgba(241, 196, 15, 0.1); }
        
        .label-group { display: flex; align-items: center; margin-bottom: 10px; font-weight: 600; color: #94a3b8; }
        .label-group i { margin-right: 10px; color: var(--primary); width: 20px; }
        
        input, select { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #334155; background: #0f172a; color: white; box-sizing: border-box; font-family: 'Prompt'; margin-top: 5px; font-size: 1rem; transition: 0.3s; }
        input:focus, select:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 8px rgba(0, 212, 255, 0.3); }
        
        .btn-save { background: var(--save); color: white; border: none; padding: 12px 25px; border-radius: 10px; cursor: pointer; float: right; font-weight: 600; margin-top: 15px; transition: 0.3s; font-family: 'Prompt'; }
        .btn-save:hover { filter: brightness(1.1); transform: translateY(-2px); }
        .btn-save:active { transform: translateY(0); }
        
        .name-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px; margin-top: 20px; }
        .house-item { background: rgba(0,0,0,0.2); padding: 15px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.05); }
        
        .warning-text { color: var(--accent); font-size: 0.8rem; display: none; margin-top: 8px; font-weight: 300; }
        .changed .warning-text { display: block; }
        .clear { clear: both; }
        
        @media (max-width: 600px) { .name-grid { grid-template-columns: 1fr; } .btn-save { width: 100%; } }
    </style>
</head>
<body>

<div class="container">
    <h1><i class="fas fa-sliders-h"></i> ตั้งค่าระบบความปลอดภัย</h1>

    <div class="section-card" id="card-village">
        <div class="label-group"><i class="fas fa-building"></i> ชื่อหมู่บ้าน / โครงการ</div>
        <input type="text" id="villageName" placeholder="เช่น หมู่บ้านรื่นรมย์" oninput="markChanged('card-village')">
        <p class="warning-text">⚠️ ข้อมูลมีการเปลี่ยนแปลง กรุณากดบันทึก</p>
        <button class="btn-save" onclick="saveData('Settings/VillageName', 'villageName', 'card-village')">บันทึกชื่อหมู่บ้าน</button>
        <div class="clear"></div>
    </div>

    <div class="section-card" id="card-theme">
        <div class="label-group"><i class="fas fa-palette"></i> โหมดการแสดงผล (Theme)</div>
        <select id="themeMode" onchange="markChanged('card-theme')">
            <option value="day">กลางวัน (Light Mode)</option>
            <option value="night">กลางคืน (Dark Mode)</option>
            <option value="auto">อัตโนมัติ (เปลี่ยนตามเวลา 6:00 - 18:00)</option>
        </select>
        <p class="warning-text">⚠️ ข้อมูลมีการเปลี่ยนแปลง กรุณากดบันทึก</p>
        <button class="btn-save" onclick="saveData('Settings/ThemeMode', 'themeMode', 'card-theme')">บันทึกธีมระบบ</button>
        <div class="clear"></div>
    </div>

    <div class="section-card" id="card-total">
        <div class="label-group"><i class="fas fa-th-large"></i> จำนวนบ้านทั้งหมด</div>
        <input type="number" id="totalHouses" placeholder="เช่น 10" oninput="markChanged('card-total')">
        <p class="warning-text">⚠️ ข้อมูลมีการเปลี่ยนแปลง กรุณากดบันทึก</p>
        <button class="btn-save" onclick="saveTotalHouses()">บันทึกจำนวนบ้าน</button>
        <div class="clear"></div>
    </div>

    <div class="section-card" id="card-snooze">
        <div class="label-group"><i class="fas fa-bell-slash"></i> เวลาหยุดเสียงชั่วคราว (Snooze)</div>
        <div style="display:flex; align-items:center; gap:10px;">
            <input type="number" id="snoozeTime" placeholder="30" oninput="markChanged('card-snooze')">
            <span style="margin-top:5px; color:#64748b;">วินาที</span>
        </div>
        <p class="warning-text">⚠️ ข้อมูลมีการเปลี่ยนแปลง กรุณากดบันทึก</p>
        <button class="btn-save" onclick="saveData('Settings/SnoozeTime', 'snoozeTime', 'card-snooze', true)">บันทึกเวลา Snooze</button>
        <div class="clear"></div>
    </div>

    <div class="section-card" id="card-names">
        <div class="label-group"><i class="fas fa-tags"></i> ชื่อเรียกบ้านแต่ละหลัง</div>
        <div id="namesContainer" class="name-grid"></div>
        <p class="warning-text">⚠️ มีการแก้ไขชื่อบ้าน กรุณากดบันทึก</p>
        <button class="btn-save" onclick="saveHouseNames()">บันทึกรายชื่อบ้านทั้งหมด</button>
        <div class="clear"></div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBGVarHKqwjhNR_BGANj8CnSWahIHtJNiM",
        authDomain: "village-security-adf63.firebaseapp.com",
        databaseURL: "https://village-security-adf63-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "village-security-adf63",
        storageBucket: "village-security-adf63.firebasestorage.app",
        appId: "1:943368318320:web:7bfb07a8c1db15952233b5"
    };

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);

    window.markChanged = (id) => { document.getElementById(id).classList.add('changed'); };

    // ฟังก์ชันบันทึกทั่วไป
    window.saveData = (path, inputId, cardId, isInt = false) => {
        let val = document.getElementById(inputId).value;
        if(isInt) val = parseInt(val);
        set(ref(database, path), val).then(() => {
            alert('บันทึกสำเร็จ');
            document.getElementById(cardId).classList.remove('changed');
        });
    };

    // บันทึกจำนวนบ้าน (กรณีพิเศษ)
    window.saveTotalHouses = () => {
        const val = parseInt(document.getElementById('totalHouses').value);
        set(ref(database, 'Settings/TotalHouses'), val).then(() => {
            alert('บันทึกจำนวนบ้านเรียบร้อย');
            document.getElementById('card-total').classList.remove('changed');
        });
    };

    // บันทึกรายชื่อบ้านทั้งหมด
    window.saveHouseNames = () => {
        const names = {};
        document.querySelectorAll('.house-input').forEach(input => {
            names[input.dataset.id] = input.value;
        });
        set(ref(database, 'Settings/HouseNames'), names).then(() => {
            alert('บันทึกรายชื่อบ้านทั้งหมดสำเร็จ');
            document.getElementById('card-names').classList.remove('changed');
        });
    };

    // โหลดข้อมูลจาก Firebase
    onValue(ref(database, 'Settings'), (snap) => {
        const data = snap.val();
        if (!data) return;

        document.getElementById('villageName').value = data.VillageName || "";
        document.getElementById('themeMode').value = data.ThemeMode || "night";
        document.getElementById('totalHouses').value = data.TotalHouses || 0;
        document.getElementById('snoozeTime').value = data.SnoozeTime || 30;

        // จัดการรายชื่อบ้าน
        const container = document.getElementById('namesContainer');
        container.innerHTML = "";
        const total = data.TotalHouses || 0;
        
        for (let i = 1; i <= total; i++) {
            const hid = "House_" + String(i).padStart(3, '0');
            const currentName = (data.HouseNames && data.HouseNames[hid]) ? data.HouseNames[hid] : "บ้านหลังที่ " + i;
            
            const div = document.createElement('div');
            div.className = "house-item";
            div.innerHTML = `
                <small style="color:var(--primary); font-weight:600;">${hid}</small>
                <input type="text" class="house-input" data-id="${hid}" value="${currentName}" oninput="markChanged('card-names')">
            `;
            container.appendChild(div);
        }
    });
</script>
</body>
</html>
